<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CentOS 7 使用二进制部署 Kubernetes 1.13集群 | kkabuzs博客屋</title><meta name="author" content="Kkabuzs"><meta name="copyright" content="Kkabuzs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  CentOS 7 使用二进制部署 Kubernetes 1.13集群一，概述 Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernet">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS 7 使用二进制部署 Kubernetes 1.13集群">
<meta property="og:url" content="https://kkabuzs.github.io/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/index.html">
<meta property="og:site_name" content="kkabuzs博客屋">
<meta property="og:description" content="无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  CentOS 7 使用二进制部署 Kubernetes 1.13集群一，概述 Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernet">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg">
<meta property="article:published_time" content="2019-04-09T02:09:37.000Z">
<meta property="article:modified_time" content="2019-04-09T02:09:37.000Z">
<meta property="article:author" content="Kkabuzs">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CentOS 7 使用二进制部署 Kubernetes 1.13集群",
  "url": "https://kkabuzs.github.io/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/",
  "image": "https://kkabuzs.github.io/themes-img/touxiang.jpg",
  "datePublished": "2019-04-09T02:09:37.000Z",
  "dateModified": "2019-04-09T02:09:37.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kkabuzs",
      "url": "https://kkabuzs.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/themes-img/touxiang.jpg"><link rel="canonical" href="https://kkabuzs.github.io/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CentOS 7 使用二进制部署 Kubernetes 1.13集群',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/themes-img/yinhe.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/themes-img/touxiang.jpg" alt="Logo"><span class="site-name">kkabuzs博客屋</span></a><a class="nav-page-title" href="/"><span class="site-name">CentOS 7 使用二进制部署 Kubernetes 1.13集群</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">CentOS 7 使用二进制部署 Kubernetes 1.13集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-04-09T02:09:37.000Z" title="发表于 2019-04-09 10:09:37">2019-04-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-04-09T02:09:37.000Z" title="更新于 2019-04-09 10:09:37">2019-04-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8%E8%87%AA%E5%8A%A8%E5%8C%96/">容器自动化</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><em>无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。</em><br><em>坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。</em></p>
</blockquote>
<h1 id="CentOS-7-使用二进制部署-Kubernetes-1-13集群"><a href="#CentOS-7-使用二进制部署-Kubernetes-1-13集群" class="headerlink" title="CentOS 7 使用二进制部署 Kubernetes 1.13集群"></a>CentOS 7 使用二进制部署 Kubernetes 1.13集群</h1><h2 id="一，概述"><a href="#一，概述" class="headerlink" title="一，概述"></a>一，概述</h2><blockquote>
<p>Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes提供了应用部署，规划，更新，维护的一种机制。</p>
</blockquote>
<h3 id="1-1-架构图"><a href="#1-1-架构图" class="headerlink" title="1.1 架构图"></a>1.1 架构图</h3><p><strong>kubernetes架构图</strong></p>
<p><img src="/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/1.png"></p>
<p><strong>Flannel网络架构图</strong></p>
<p><img src="/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/2.png"></p>
<blockquote>
<ul>
<li>数据从源容器中发出后，经由所在主机的docker0虚拟网卡转发到flannel0虚拟网卡，这是个P2P的虚拟网卡，flanneld服务监听在网卡的另外一端。</li>
<li>Flannel通过Etcd服务维护了一张节点间的路由表，在稍后的配置部分我们会介绍其中的内容。</li>
<li>源主机的flanneld服务将原本的数据内容UDP封装后根据自己的路由表投递给目的节点的flanneld服务，数据到达以后被解包，然后直接进入目的节点的flannel0虚拟网卡，然后被转发到目的主机的docker0虚拟网卡，最后就像本机容器通信一下的有docker0路由到达目标容器。</li>
</ul>
</blockquote>
<h2 id="二，二进制部署kubernetes-1-13集群"><a href="#二，二进制部署kubernetes-1-13集群" class="headerlink" title="二，二进制部署kubernetes 1.13集群"></a>二，二进制部署kubernetes 1.13集群</h2><h3 id="2-1-安装环境准备"><a href="#2-1-安装环境准备" class="headerlink" title="2.1 安装环境准备"></a>2.1 安装环境准备</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>CPU</th>
<th>内存</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master01</td>
<td>192.168.101.61</td>
<td>2核</td>
<td>4GB</td>
<td>k8s master节点</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.101.62</td>
<td>2核</td>
<td>4GB</td>
<td>k8s node节点</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.101.125</td>
<td>2核</td>
<td>4GB</td>
<td>k8s node节点</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化环境</span></span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cat</span> /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">uname</span> -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line">[root@k8s-master01 ~]# setenforce 0</span><br><span class="line">setenforce: SELinux is disabled</span><br><span class="line">[root@k8s-master01 ~]# systemctl stop firewalld</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加hosts映射</span></span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">192.168.101.61 k8s-master01</span><br><span class="line">192.168.101.62 k8s-node01</span><br><span class="line">192.168.101.125 k8s-node02</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭swap缓存</span></span><br><span class="line">[root@k8s-master01 ~]# vim /etc/fstab</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cat</span> /etc/fstab | grep swap</span><br><span class="line"><span class="comment">#UUID=40ab8144-1f1d-48ef-9a00-8ee7e0cfb2db swap                    swap    defaults        0 0</span></span><br><span class="line">[root@k8s-master01 ~]# swapoff -a</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">echo</span> <span class="string">&quot;swapoff -a&quot;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-安装docker"><a href="#2-2-安装docker" class="headerlink" title="2.2 安装docker"></a>2.2 安装docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">adding repo from: https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">grabbing file https://download.docker.com/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">repo saved to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">[root@k8s-master01 ~]# yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">已安装的软件包</span><br><span class="line">可安装的软件包</span><br><span class="line"> * updates: mirrors.huaweicloud.com</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * extras: mirror.jdcloud.com</span><br><span class="line">docker-ce.x86_64            3:18.09.4-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.3-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.2-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.1-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.0-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.3.ce-3.el7                   docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.2.ce-3.el7                   docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.1.ce-3.el7                   docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.0.ce-3.el7                   docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.1.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.0.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.1.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.0.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.1.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.0.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.2.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.1.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.0.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.3.ce-1.el7                   docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.2.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</span><br><span class="line"> * base: mirrors.huaweicloud.com</span><br><span class="line">[root@k8s-master01 ~]# yum -y install docker-ce     <span class="comment">#安装新版docker</span></span><br><span class="line">[root@k8s-master01 ~]# systemctl start docker</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">enable</span> docker</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">[root@k8s-master01 ~]# docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.4</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.8</span><br><span class="line"> Git commit:        d14af54266</span><br><span class="line"> Built:             Wed Mar 27 18:34:51 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.4</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.8</span><br><span class="line">  Git commit:       d14af54</span><br><span class="line">  Built:            Wed Mar 27 18:04:46 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-创建安装目录"><a href="#2-3-创建安装目录" class="headerlink" title="2.3 创建安装目录"></a>2.3 创建安装目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">mkdir</span> -p /k8s/etcd/&#123;bin,cfg,ssl&#125;</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mkdir</span> -p /k8s/kubernetes/&#123;bin,cfg,ssl&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-安装及配置CFSSL"><a href="#2-4-安装及配置CFSSL" class="headerlink" title="2.4 安装及配置CFSSL"></a>2.4 安装及配置CFSSL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">[root@k8s-master01 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">[root@k8s-master01 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h3 id="2-5-创建认证证书"><a href="#2-5-创建认证证书" class="headerlink" title="2.5 创建认证证书"></a>2.5 创建认证证书</h3><h4 id="2-5-1-创建-ETCD-CA-配置文件"><a href="#2-5-1-创建-ETCD-CA-配置文件" class="headerlink" title="2.5.1 创建 ETCD CA 配置文件"></a>2.5.1 创建 ETCD CA 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /k8s/</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">ls</span></span><br><span class="line">etcd  kubernetes</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">mkdir</span> etcd_ssl    <span class="comment">#证书的原json文件目录</span></span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">cd</span> etcd_ssl/</span><br><span class="line">[root@k8s-master01 etcd_ssl]# <span class="built_in">cat</span> ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;signing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">	<span class="string">&quot;profiles&quot;</span>: &#123;</span><br><span class="line">	    <span class="string">&quot;www&quot;</span>: &#123;</span><br><span class="line">	        <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">	            <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;server auth&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;client auth&quot;</span></span><br><span class="line">	        ]</span><br><span class="line">	    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-2-创建ETCD-CA-证书"><a href="#2-5-2-创建ETCD-CA-证书" class="headerlink" title="2.5.2 创建ETCD CA 证书"></a>2.5.2 创建ETCD CA 证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 etcd_ssl]# <span class="built_in">cat</span> ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;etcd CA&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-3-创建ETCD-server-证书"><a href="#2-5-3-创建ETCD-server-证书" class="headerlink" title="2.5.3 创建ETCD server 证书"></a>2.5.3 创建ETCD server 证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 etcd_ssl]# <span class="built_in">cat</span> server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;etcd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;192.168.101.61&quot;</span>,</span><br><span class="line">        <span class="string">&quot;192.168.101.62&quot;</span>,</span><br><span class="line">        <span class="string">&quot;192.168.101.125&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-4-生成ETCD-CA-证书和秘钥"><a href="#2-5-4-生成ETCD-CA-证书和秘钥" class="headerlink" title="2.5.4 生成ETCD CA 证书和秘钥"></a>2.5.4 生成ETCD CA 证书和秘钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 etcd_ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">2019/04/09 16:34:08 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/04/09 16:34:08 [INFO] generate received request</span><br><span class="line">2019/04/09 16:34:08 [INFO] received CSR</span><br><span class="line">2019/04/09 16:34:08 [INFO] generating key: rsa-2048</span><br><span class="line">2019/04/09 16:34:08 [INFO] encoded CSR</span><br><span class="line">2019/04/09 16:34:08 [INFO] signed certificate with serial number 1858391312899192952195491720058889354936121860</span><br><span class="line">[root@k8s-master01 etcd_ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line">2019/04/09 16:34:21 [INFO] generate received request</span><br><span class="line">2019/04/09 16:34:21 [INFO] received CSR</span><br><span class="line">2019/04/09 16:34:21 [INFO] generating key: rsa-2048</span><br><span class="line">2019/04/09 16:34:21 [INFO] encoded CSR</span><br><span class="line">2019/04/09 16:34:21 [INFO] signed certificate with serial number 343223696251067460467278984517292985436327989284</span><br><span class="line">2019/04/09 16:34:21 [WARNING] This certificate lacks a <span class="string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">&quot;Information Requirements&quot;</span>).</span><br></pre></td></tr></table></figure>

<h4 id="2-5-5-创建Kubernetes-CA-配置文件"><a href="#2-5-5-创建Kubernetes-CA-配置文件" class="headerlink" title="2.5.5 创建Kubernetes CA 配置文件"></a>2.5.5 创建Kubernetes CA 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /k8s/</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">ls</span></span><br><span class="line">etcd  etcd_ssl  kubernetes</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">mkdir</span> k8s_ssl</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">cd</span> k8s_ssl/</span><br><span class="line">[root@k8s-master01 k8s_ssl]# <span class="built_in">cat</span> ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;signing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">	<span class="string">&quot;profiles&quot;</span>: &#123;</span><br><span class="line">	    <span class="string">&quot;kubernetes&quot;</span>: &#123;</span><br><span class="line">	        <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">	            <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;server auth&quot;</span>,</span><br><span class="line">	            <span class="string">&quot;client auth&quot;</span></span><br><span class="line">	        ]</span><br><span class="line">	    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">字段说明：</span><br><span class="line">ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</span><br><span class="line">signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</span><br><span class="line">server auth：表示client可以用该 CA 对server提供的证书进行验证；</span><br><span class="line">client auth：表示server可以用该CA对client提供的证书进行验证；</span><br></pre></td></tr></table></figure>

<h4 id="2-5-6-创建Kubernetes-CA-证书"><a href="#2-5-6-创建Kubernetes-CA-证书" class="headerlink" title="2.5.6 创建Kubernetes CA 证书"></a>2.5.6 创建Kubernetes CA 证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s_ssl]# <span class="built_in">cat</span> ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;System&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">字段说明：</span><br><span class="line"><span class="string">&quot;CN&quot;</span>：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</span><br><span class="line"><span class="string">&quot;O&quot;</span>：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成kubernetes ca 证书</span></span><br><span class="line">[root@k8s-master01 k8s_ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">2019/04/09 17:49:09 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/04/09 17:49:09 [INFO] generate received request</span><br><span class="line">2019/04/09 17:49:09 [INFO] received CSR</span><br><span class="line">2019/04/09 17:49:09 [INFO] generating key: rsa-2048</span><br><span class="line">2019/04/09 17:49:09 [INFO] encoded CSR</span><br><span class="line">2019/04/09 17:49:09 [INFO] signed certificate with serial number 555134987760584209046061419310967914967122746147</span><br></pre></td></tr></table></figure>

<h4 id="2-5-7-创建kubernetes（api-server）证书"><a href="#2-5-7-创建kubernetes（api-server）证书" class="headerlink" title="2.5.7 创建kubernetes（api server）证书"></a>2.5.7 创建kubernetes（api server）证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s_ssl]# <span class="built_in">cat</span> kubernetes-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.101.61&quot;</span>,         <span class="comment">#多master要把所有对master ip都写入</span></span><br><span class="line">      <span class="string">&quot;10.254.0.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes.default&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">            <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">            <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;System&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，由于该证书后续被 etcd 集群和 kubernetes master 集群使用，所以上面分别指定了 etcd 集群、kubernetes master 集群的主机 IP 和 kubernetes 服务的服务 IP（一般是 kube-apiserver 指定的 service-cluster-ip-range 网段的第一个IP，如 10.254.0.1）。</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成api证书</span></span><br><span class="line">[root@k8s-master01 k8s_ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">2019/04/09 18:00:43 [INFO] generate received request</span><br><span class="line">2019/04/09 18:00:43 [INFO] received CSR</span><br><span class="line">2019/04/09 18:00:43 [INFO] generating key: rsa-2048</span><br><span class="line">2019/04/09 18:00:43 [INFO] encoded CSR</span><br><span class="line">2019/04/09 18:00:43 [INFO] signed certificate with serial number 457042607143982312188093687656561650451025479321</span><br><span class="line">2019/04/09 18:00:43 [WARNING] This certificate lacks a <span class="string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">&quot;Information Requirements&quot;</span>).</span><br></pre></td></tr></table></figure>

<h4 id="2-5-8-创建kubernetes-proxy-证书"><a href="#2-5-8-创建kubernetes-proxy-证书" class="headerlink" title="2.5.8 创建kubernetes proxy 证书"></a>2.5.8 创建kubernetes proxy 证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s_ssl]# <span class="built_in">cat</span> kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;system:kube-proxy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;L&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;System&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成proxy证书：</span></span><br><span class="line">[root@k8s-master01 k8s_ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">2019/04/10 10:01:01 [INFO] generate received request</span><br><span class="line">2019/04/10 10:01:01 [INFO] received CSR</span><br><span class="line">2019/04/10 10:01:01 [INFO] generating key: rsa-2048</span><br><span class="line">2019/04/10 10:01:01 [INFO] encoded CSR</span><br><span class="line">2019/04/10 10:01:01 [INFO] signed certificate with serial number 51986653818425940642544047698063489093161203532</span><br><span class="line">2019/04/10 10:01:01 [WARNING] This certificate lacks a <span class="string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">&quot;Information Requirements&quot;</span>).</span><br></pre></td></tr></table></figure>

<h4 id="2-5-9-校验证书"><a href="#2-5-9-校验证书" class="headerlink" title="2.5.9 校验证书"></a>2.5.9 校验证书</h4><blockquote>
<p>共有两种方法，一种是用openssl命令，另一种是用cfssl-certinfo命令。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用openssl命令校验（以kubernetes证书为例：）</span></span><br><span class="line">[root@k8s-master01 k8s_ssl]# openssl x509  -noout -text -<span class="keyword">in</span>  kubernetes.pem</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            50:0e:7f:d2:f5:04:b6:bd:a0:6d:9e:0d:16:61:ac:d1:41:ef:c6:99</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Apr  9 09:56:00 2019 GMT</span><br><span class="line">            Not After : Apr  6 09:56:00 2029 GMT</span><br><span class="line">        Subject: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:cc:55:52:7d:19:66:58:86:97:6d:3a:0a:b7:7c:</span><br><span class="line">                    b3:a2:16:7c:f5:bf:e1:92:a0:a7:d2:7a:86:e9:6b:</span><br><span class="line">                    41:8a:22:c0:c7:a7:79:e6:ae:ef:3e:60:c9:64:4d:</span><br><span class="line">                    8e:10:67:3b:f1:3c:e3:39:8e:f4:5a:65:47:2d:85:</span><br><span class="line">                    fb:31:28:25:1f:bd:f9:5d:9a:81:1b:2b:3a:9b:33:</span><br><span class="line">                    60:9b:92:07:b7:f3:a7:f9:35:dc:2b:a0:8d:18:29:</span><br><span class="line">                    6c:52:e2:c6:d7:86:cf:c6:3d:fe:ab:6b:06:37:b3:</span><br><span class="line">                    37:0e:51:61:1e:16:2d:28:0f:ef:a0:a1:22:4c:b9:</span><br><span class="line">                    88:ec:c1:94:fd:30:4e:<span class="built_in">df</span>:4a:3e:f5:b7:bf:c0:72:</span><br><span class="line">                    bc:bf:69:d8:24:db:5e:d2:e4:d0:3d:a4:d3:94:04:</span><br><span class="line">                    35:ff:f4:8f:95:fd:23:1a:c3:06:0b:5e:73:b4:56:</span><br><span class="line">                    1b:8e:4c:9b:15:6a:21:ae:65:2d:f7:89:<span class="built_in">dd</span>:84:8d:</span><br><span class="line">                    7b:5b:d0:71:ca:b7:<span class="built_in">cd</span>:c0:cc:05:36:ce:93:3f:84:</span><br><span class="line">                    5f:f8:a2:1c:86:96:ae:96:0a:46:9c:1f:65:68:e5:</span><br><span class="line">                    70:cb:de:1c:36:45:70:8b:3c:9e:53:2c:12:c7:fd:</span><br><span class="line">                    e5:99:04:22:8f:16:a1:82:61:8f:89:db:86:3e:a8:</span><br><span class="line">                    66:b7:54:85:ab:4c:7d:78:c0:e7:78:c4:f5:69:a7:</span><br><span class="line">                    7c:ad</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                D0:52:1D:C3:61:26:65:43:92:55:9B:77:67:D3:F5:93:E4:BA:AC:0F</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:21:7A:58:CF:F4:BC:08:88:5D:DF:81:E5:0C:87:42:9C:EE:48:9F:3B</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:192.168.101.61, IP Address:10.254.0.1</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         35:45:b5:af:3e:bd:5a:0d:cf:d2:<span class="built_in">df</span>:11:72:7a:86:19:b3:55:</span><br><span class="line">         30:b1:3f:35:a9:a2:5c:c1:f3:15:ec:b4:5c:27:25:c4:fd:fe:</span><br><span class="line">         3f:<span class="built_in">df</span>:f9:9f:29:<span class="built_in">df</span>:13:f6:87:07:73:11:73:1b:84:3c:71:69:</span><br><span class="line">         37:a0:7c:41:b6:c8:1a:0b:69:8a:da:b1:6e:cb:6c:da:32:49:</span><br><span class="line">         e6:9a:3b:c7:4b:4c:73:<span class="built_in">cd</span>:ce:57:20:ca:45:64:9d:46:e9:33:</span><br><span class="line">         11:7d:b1:e3:59:49:d8:4a:17:c2:08:76:ed:73:b9:12:b3:d1:</span><br><span class="line">         3b:67:31:1a:31:66:a9:3e:aa:8a:0c:fe:b1:01:c1:06:77:25:</span><br><span class="line">         e2:e0:8c:0f:be:23:9f:fe:70:21:e1:5b:b6:83:75:18:9c:72:</span><br><span class="line">         f0:f5:e9:<span class="built_in">fc</span>:20:78:7a:00:7f:ef:9b:8c:5b:85:c9:d6:9f:5f:</span><br><span class="line">         15:45:7c:8e:14:81:ba:ee:36:ac:4b:a3:8e:84:5d:6a:31:3b:</span><br><span class="line">         cb:94:0f:cb:1d:47:e2:69:9d:e4:b3:41:c4:86:31:8b:02:ac:</span><br><span class="line">         e4:a1:27:af:1b:eb:22:9a:17:c7:4b:96:2f:41:cb:69:87:63:</span><br><span class="line">         88:61:84:88:34:bf:1c:f7:65:3a:a6:0f:b4:53:<span class="built_in">dd</span>:<span class="built_in">df</span>:c5:f7:</span><br><span class="line">         19:c6:ee:81:20:8b:98:6c:4a:94:c0:10:6b:49:16:57:17:f4:</span><br><span class="line">         8c:60:d4:93</span><br><span class="line">         </span><br><span class="line">说明：</span><br><span class="line">确认 Issuer 字段的内容和 ca-csr.json 一致；</span><br><span class="line">确认 Subject 字段的内容和 kubernetes-csr.json 一致；</span><br><span class="line">确认 X509v3 Subject Alternative Name 字段的内容和 kubernetes-csr.json 一致；</span><br><span class="line">确认 X509v3 Key Usage、Extended Key Usage 字段的内容和 ca-config.json 中 kubernetes profile 一致；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用cfssl-certinfo命令校验：</span></span><br><span class="line">[root@k8s-master01 k8s_ssl]# cfssl-certinfo -cert kubernetes.pem</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;subject&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;common_name&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organization&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organizational_unit&quot;</span>: <span class="string">&quot;System&quot;</span>,</span><br><span class="line">    <span class="string">&quot;locality&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;province&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;System&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;issuer&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;common_name&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organization&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;organizational_unit&quot;</span>: <span class="string">&quot;System&quot;</span>,</span><br><span class="line">    <span class="string">&quot;locality&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;province&quot;</span>: <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;BeiJing&quot;</span>,</span><br><span class="line">      <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;System&quot;</span>,</span><br><span class="line">      <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;serial_number&quot;</span>: <span class="string">&quot;457042607143982312188093687656561650451025479321&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sans&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,</span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.101.61&quot;</span>,</span><br><span class="line">    <span class="string">&quot;10.254.0.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;not_before&quot;</span>: <span class="string">&quot;2019-04-09T09:56:00Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;not_after&quot;</span>: <span class="string">&quot;2029-04-06T09:56:00Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sigalg&quot;</span>: <span class="string">&quot;SHA256WithRSA&quot;</span>,</span><br><span class="line">  ···省略若干内容···</span><br></pre></td></tr></table></figure>

<h3 id="2-6-三台机器相互ssh-key免密钥"><a href="#2-6-三台机器相互ssh-key免密钥" class="headerlink" title="2.6 三台机器相互ssh-key免密钥"></a>2.6 三台机器相互ssh-key免密钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:zzyyxu5/AOAJ4b1zQ+kN1lxjfwtLjtspdUG0Cx5eT70 root@k8s-master01</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|    ..      + .o |</span></span><br><span class="line"><span class="string">|   ....  + o o. o|</span></span><br><span class="line"><span class="string">|    .o.o= o  =.++|</span></span><br><span class="line"><span class="string">|      o=.o  * *o*|</span></span><br><span class="line"><span class="string">|      o S... * E.|</span></span><br><span class="line"><span class="string">|       o =. + o  |</span></span><br><span class="line"><span class="string">|       .. =+ o   |</span></span><br><span class="line"><span class="string">|        oo .o    |</span></span><br><span class="line"><span class="string">|       ++...     |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string">[root@k8s-master01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.101.62</span></span><br><span class="line"><span class="string">[root@k8s-master01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.101.125</span></span><br></pre></td></tr></table></figure>

<h2 id="三，部署ETCD集群"><a href="#三，部署ETCD集群" class="headerlink" title="三，部署ETCD集群"></a>三，部署ETCD集群</h2><h3 id="3-1-解压安装文件"><a href="#3-1-解压安装文件" class="headerlink" title="3.1 解压安装文件"></a>3.1 解压安装文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.1.10/etcd-v3.1.10-linux-amd64.tar.gz       <span class="comment">#没有安装包需先下载</span></span><br><span class="line">[root@k8s-master01 ~]# tar xf etcd-v3.3.10-linux-amd64.tar.gz -C /usr/src/</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /usr/src/etcd-v3.3.10-linux-amd64/</span><br><span class="line">[root@k8s-master01 etcd-v3.3.10-linux-amd64]# <span class="built_in">ls</span></span><br><span class="line">Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line">[root@k8s-master01 etcd-v3.3.10-linux-amd64]# <span class="built_in">cp</span> etcd etcdctl /k8s/etcd/bin/</span><br><span class="line">[root@k8s-master01 etcd-v3.3.10-linux-amd64]# <span class="built_in">ls</span> /k8s/etcd/bin/</span><br><span class="line">etcd  etcdctl</span><br></pre></td></tr></table></figure>

<h3 id="3-2-创建-etcd-的-systemd-unit-文件"><a href="#3-2-创建-etcd-的-systemd-unit-文件" class="headerlink" title="3.2 创建 etcd 的 systemd unit 文件"></a>3.2 创建 etcd 的 systemd unit 文件</h3><blockquote>
<p>在&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;目录下创建文件etcd.service，内容如下。注意替换IP地址为你自己的etcd集群的主机IP。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">mkdir</span> /var/lib/etcd          <span class="comment">#创建目录</span></span><br><span class="line">[root@k8s-master01 etcd-v3.3.10-linux-amd64]# <span class="built_in">cd</span> /usr/lib/systemd/system/</span><br><span class="line">[root@k8s-master01 system]# vim etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/     <span class="comment">#切记，此目录需要手动创建，三台都创建</span></span><br><span class="line">EnvironmentFile=/k8s/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/k8s/etcd/bin/etcd \</span><br><span class="line">  --name <span class="variable">$&#123;ETCD_NAME&#125;</span> \</span><br><span class="line">  --cert-file=/k8s/etcd/ssl/server.pem \</span><br><span class="line">  --key-file=/k8s/etcd/ssl/server-key.pem \</span><br><span class="line">  --peer-cert-file=/k8s/etcd/ssl/server.pem \</span><br><span class="line">  --peer-key-file=/k8s/etcd/ssl/server-key.pem \</span><br><span class="line">  --trusted-ca-file=/k8s/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/k8s/etcd/ssl/ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls <span class="variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> \</span><br><span class="line">  --listen-peer-urls <span class="variable">$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> \</span><br><span class="line">  --listen-client-urls <span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls <span class="variable">$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> \</span><br><span class="line">  --initial-cluster-token <span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.101.61:2380,etcd02=https://192.168.101.62:2380,etcd03=https://192.168.101.125:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">指定 etcd 的工作目录为 /var/lib/etcd，数据目录为 /var/lib/etcd，需在启动服务前创建这个目录，否则启动服务的时候会报错“Failed at step CHDIR spawning /usr/bin/etcd: No such file or directory”；</span><br><span class="line"></span><br><span class="line">为了保证通信安全，需要指定 etcd 的公私钥(cert-file和key-file)、Peers 通信的公私钥和 CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA证书（trusted-ca-file）；</span><br><span class="line"></span><br><span class="line">创建 kubernetes.pem 证书时使用的 kubernetes-csr.json 文件的 hosts 字段包含所有 etcd 节点的IP，否则证书校验会出错；</span><br><span class="line"></span><br><span class="line">--initial-cluster-state值为new时，--name的参数值必须位于--initial-cluster 列表中；</span><br><span class="line"></span><br><span class="line">RestartSec=5  服务重启等待五秒</span><br></pre></td></tr></table></figure>

<h3 id="3-3-创建etcd的环境变量配置文件"><a href="#3-3-创建etcd的环境变量配置文件" class="headerlink" title="3.3 创建etcd的环境变量配置文件"></a>3.3 创建etcd的环境变量配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 system]# <span class="built_in">cd</span> /k8s/etcd/cfg/</span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd01&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.101.61:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.101.61:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.101.61:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.101.61:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line">这是192.168.101.61节点的配置，其他两个etcd节点只要将上面的IP地址改成相应节点的IP地址即可。ETCD_NAME换成对应节点的etcd01/02/03。</span><br></pre></td></tr></table></figure>

<h3 id="3-4-拷贝证书文件"><a href="#3-4-拷贝证书文件" class="headerlink" title="3.4 拷贝证书文件"></a>3.4 拷贝证书文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span>  /k8s/</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">ls</span></span><br><span class="line">etcd  etcd_ssl  k8s_ssl  kubernetes</span><br><span class="line">[root@k8s-master01 k8s]# <span class="built_in">cd</span> etcd_ssl/</span><br><span class="line">[root@k8s-master01 etcd_ssl]# <span class="built_in">ls</span></span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  server.csr  server-csr.json  server-key.pem  server.pem</span><br><span class="line">[root@k8s-master01 etcd_ssl]# <span class="built_in">cp</span> *.pem /k8s/etcd/ssl/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-5-将启动文件、配置文件拷贝到节点62、节点125"><a href="#3-5-将启动文件、配置文件拷贝到节点62、节点125" class="headerlink" title="3.5 将启动文件、配置文件拷贝到节点62、节点125"></a>3.5 将启动文件、配置文件拷贝到节点62、节点125</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# <span class="built_in">mkdir</span> /k8s         <span class="comment">#62机器</span></span><br><span class="line">[root@k8s-node02 ~]# <span class="built_in">mkdir</span> /k8s         <span class="comment">#125机器</span></span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /k8s/</span><br><span class="line">[root@k8s-master01 k8s]# scp -r etcd 192.168.101.62:/k8s/</span><br><span class="line">etcd                                                                                                                                                                      100%   18MB 136.1MB/s   00:00</span><br><span class="line">etcdctl                                                                                                                                                                   100%   15MB 130.7MB/s   00:00</span><br><span class="line">etcd.conf                                                                                                                                                                 100%  340   589.1KB/s   00:00</span><br><span class="line">ca-key.pem                                                                                                                                                                100% 1675     2.8MB/s   00:00</span><br><span class="line">ca.pem                                                                                                                                                                    100% 1265     2.8MB/s   00:00</span><br><span class="line">server-key.pem                                                                                                                                                            100% 1675     3.3MB/s   00:00</span><br><span class="line">server.pem                                                                                                                                                                100% 1338     2.9MB/s   00:00</span><br><span class="line">[root@k8s-master01 k8s]# scp -r etcd 192.168.101.125:/k8s/</span><br><span class="line">etcd                                                                                                                                                                      100%   18MB 140.2MB/s   00:00</span><br><span class="line">etcdctl                                                                                                                                                                   100%   15MB 138.0MB/s   00:00</span><br><span class="line">etcd.conf                                                                                                                                                                 100%  340     1.0MB/s   00:00</span><br><span class="line">ca-key.pem                                                                                                                                                                100% 1675     5.2MB/s   00:00</span><br><span class="line">ca.pem                                                                                                                                                                    100% 1265     4.1MB/s   00:00</span><br><span class="line">server-key.pem                                                                                                                                                            100% 1675     5.5MB/s   00:00</span><br><span class="line">server.pem                                                                                                                                                                100% 1338     4.4MB/s   00:00</span><br><span class="line">[root@k8s-master01 k8s]# scp /usr/lib/systemd/system/etcd.service 192.168.101.62:/usr/lib/systemd/system/etcd.service</span><br><span class="line">etcd.service                                                                                                                                                              100% 1115     2.8MB/s   00:00</span><br><span class="line">[root@k8s-master01 k8s]# scp /usr/lib/systemd/system/etcd.service 192.168.101.125:/usr/lib/systemd/system/etcd.service</span><br><span class="line">etcd.service                                                                                                                                                              100% 1115     1.5MB/s   00:00</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#62机器操作：</span></span><br><span class="line">[root@k8s-node01 ~]# vim /k8s/etcd/cfg/etcd.conf</span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd02&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.101.62:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.101.62:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.101.62:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.101.62:2379&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#125机器操作：</span></span><br><span class="line">[root@k8s-node02 ~]# vim /k8s/etcd/cfg/etcd.conf</span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd03&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.101.125:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.101.125:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.101.125:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.101.125:2379&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-6-启动ETCD集群"><a href="#3-6-启动ETCD集群" class="headerlink" title="3.6 启动ETCD集群"></a>3.6 启动ETCD集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#三台都启动ETCD服务</span></span><br><span class="line">[root@k8s-master01 etcd_ssl]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master01 etcd_ssl]# systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.</span><br><span class="line">[root@k8s-master01 etcd_ssl]# systemctl start etcd</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证集群是否正常运行</span></span><br><span class="line">[root@k8s-master01 ~]# /k8s/etcd/bin/etcdctl --ca-file=/k8s/etcd/ssl/ca.pem --cert-file=/k8s/etcd/ssl/server.pem --key-file=/k8s/etcd/ssl/server-key.pem --endpoints=<span class="string">&quot;https://192.168.101.61:2379,https://192.169.101.62:2379,https://192.168.101.125:2379&quot;</span> cluster-health</span><br><span class="line">member 7773640f74d528b1 is healthy: got healthy result from https://192.168.101.61:2379</span><br><span class="line">member 876df443efa52353 is healthy: got healthy result from https://192.168.101.62:2379</span><br><span class="line">member f859f1a325e5abf6 is healthy: got healthy result from https://192.168.101.125:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>

<p><strong>附录：防火墙设置方法</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#iptables防火墙：</span></span><br><span class="line">[root@k8s-master01 ~]# iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 2379 -j ACCEPT</span><br><span class="line">[root@k8s-master01 ~]# iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 2380 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#firewalld防火墙：</span></span><br><span class="line">firewall-cmd --zone=public --add-port=2380/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=2379/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="四，部署-Flannel-网络"><a href="#四，部署-Flannel-网络" class="headerlink" title="四，部署 Flannel 网络"></a>四，部署 Flannel 网络</h2><h3 id="4-1-向-ETCD-写入集群-Pod-信息"><a href="#4-1-向-ETCD-写入集群-Pod-信息" class="headerlink" title="4.1 向 ETCD 写入集群 Pod 信息"></a>4.1 向 ETCD 写入集群 Pod 信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /k8s/etcd/ssl/</span><br><span class="line">[root@k8s-master01 ssl]# /k8s/etcd/bin/etcdctl --ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem --endpoints=<span class="string">&quot;https://192.168.101.61:2379,https://192.168.101:2379.62,https://192.168.101.125:2379&quot;</span> <span class="built_in">mkdir</span> /kube-centos/network</span><br><span class="line">[root@k8s-master01 ssl]# /k8s/etcd/bin/etcdctl --ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem --endpoints=<span class="string">&quot;https://192.168.101.61:2379,https://192.168.101:2379.62,https://192.168.101.125:2379&quot;</span> mk /kube-centos/network/config <span class="string">&#x27;&#123; &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;Backend&quot;: &#123; &quot;Type&quot;: &quot;vxlan&quot; &#125; &#125;&#x27;</span></span><br><span class="line">&#123; <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;172.30.0.0/16&quot;</span>, <span class="string">&quot;Backend&quot;</span>: &#123; <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line">flanneld 当前版本 (v0.10.0) 不支持 etcd v3，故使用 etcd v2 API 写入配置 key 和网段数据；</span><br><span class="line"></span><br><span class="line">写入的 Pod 网段 <span class="variable">$&#123;CLUSTER_CIDR&#125;</span> 必须是 /16 段地址，必须与 kube-controller-manager 的 –cluster-cidr 参数值一致；</span><br><span class="line"></span><br><span class="line">如果你要使用host-gw模式，可以直接将vxlan改成host-gw即可。</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看网络是否写进ETCD集群</span></span><br><span class="line">[root@k8s-master01 ~]# /k8s/etcd/bin/etcdctl --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">   --ca-file=/k8s/etcd/ssl/ca.pem \</span><br><span class="line">   --cert-file=/k8s/etcd/ssl/server.pem \</span><br><span class="line">   --key-file=/k8s/etcd/ssl/server-key.pem \</span><br><span class="line">   get /kube-centos/network/config</span><br><span class="line">&#123; <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;172.30.0.0/16&quot;</span>, <span class="string">&quot;Backend&quot;</span>: &#123; <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-解压安装Flannel"><a href="#4-2-解压安装Flannel" class="headerlink" title="4.2 解压安装Flannel"></a>4.2 解压安装Flannel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master01 ~]# tar xf flannel-v0.10.0-linux-amd64.tar.gz -C /usr/src/</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> /usr/src/&#123;flanneld,mk-docker-opts.sh&#125; /k8s/kubernetes/bin/</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">ls</span> /k8s/kubernetes/bin/</span><br><span class="line">flanneld  mk-docker-opts.sh</span><br></pre></td></tr></table></figure>

<h3 id="4-3-配置Flannel"><a href="#4-3-配置Flannel" class="headerlink" title="4.3 配置Flannel"></a>4.3 配置Flannel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=<span class="string">&quot;https://192.168.101.61:2379,https://192.168.101.62:2379,https://192.168.101.125:2379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># # For address range assignment</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">&quot;/kube-centos/network&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">&quot;-etcd-cafile=/k8s/etcd/ssl/ca.pem -etcd-certfile=/k8s/etcd/ssl/server.pem -etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-创建Flannel的systemd-unit文件"><a href="#4-4-创建Flannel的systemd-unit文件" class="headerlink" title="4.4 创建Flannel的systemd unit文件"></a>4.4 创建Flannel的systemd unit文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /usr/lib/systemd/system/flanneld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/docker-network</span><br><span class="line">EnvironmentFile=/k8s/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/flanneld -etcd-endpoints=<span class="variable">$&#123;FLANNEL_ETCD_ENDPOINTS&#125;</span> -etcd-prefix=<span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span> <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/k8s/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
</blockquote>
<ul>
<li>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网网段信息写入 &#x2F;run&#x2F;flannel&#x2F;docker 文件，后续 docker 启动时 使用这个文件中的环境变量配置 docker0 网桥；</li>
<li>flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口，如上面的 eth0 接口;</li>
<li>flanneld 运行时需要 root 权限；</li>
</ul>
<h3 id="4-5-配置docker启动，自定义子网网段"><a href="#4-5-配置docker启动，自定义子网网段" class="headerlink" title="4.5 配置docker启动，自定义子网网段"></a>4.5 配置docker启动，自定义子网网段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">cat</span> /usr/lib/systemd/system/docker.service | egrep <span class="string">&quot;ExecStart|Env&quot;</span></span><br><span class="line">EnvironmentFile=/run/flannel/docker</span><br><span class="line"><span class="comment">#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line">注释掉默认行，添加两行新内容</span><br></pre></td></tr></table></figure>

<h3 id="4-6-将flanneld-systemd-unit-文件到所有节点"><a href="#4-6-将flanneld-systemd-unit-文件到所有节点" class="headerlink" title="4.6 将flanneld systemd unit 文件到所有节点"></a>4.6 将flanneld systemd unit 文件到所有节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# scp -r /k8s/kubernetes 192.168.101.62:/k8s/</span><br><span class="line">flanneld                                                                                                                                                                  100%   35MB 121.7MB/s   00:00</span><br><span class="line">mk-docker-opts.sh                                                                                                                                                         100% 2139     3.5MB/s   00:00</span><br><span class="line">flanneld                                                                                                                                                                  100%  356   733.3KB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp -r /k8s/kubernetes 192.168.101.125:/k8s/</span><br><span class="line">flanneld                                                                                                                                                                  100%   35MB 135.2MB/s   00:00</span><br><span class="line">mk-docker-opts.sh                                                                                                                                                         100% 2139     4.6MB/s   00:00</span><br><span class="line">flanneld                                                                                                                                                                  100%  356   817.7KB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /usr/lib/systemd/system/docker.service 192.168.101.62:/usr/lib/systemd/system/docker.service</span><br><span class="line">docker.service                                                                                                                                                            100% 1736     3.4MB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /usr/lib/systemd/system/docker.service 192.168.101.125:/usr/lib/systemd/system/docker.service</span><br><span class="line">docker.service                                                                                                                                                            100% 1736     3.2MB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /usr/lib/systemd/system/flanneld.service 192.168.101.62:/usr/lib/systemd/system/flanneld.service</span><br><span class="line">flanneld.service                                                                                                                                                          100%  458   867.0KB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /usr/lib/systemd/system/flanneld.service 192.168.101.125:/usr/lib/systemd/system/flanneld.service</span><br><span class="line">flanneld.service                                                                                                                                                          100%  458     1.1MB/s   00:00</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务（所有机器）</span></span><br><span class="line">[root@k8s-master01 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master01 ~]# systemctl start flanneld</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">enable</span> flanneld</span><br><span class="line">[root@k8s-master01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否生效</span></span><br><span class="line">[root@k8s-master01 ssl]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:50:56:a6:c6:5d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.101.61/23 brd 192.168.101.255 scope global dynamic ens192</span><br><span class="line">       valid_lft 6722sec preferred_lft 6722sec</span><br><span class="line">    inet6 fe80::250:56ff:fea6:c65d/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:45:fb:1e:bf brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.18.1/24 brd 172.30.18.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 6e:40:51:7e:f3:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.18.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c40:51ff:fe7e:f301/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="五，部署master节点"><a href="#五，部署master节点" class="headerlink" title="五，部署master节点"></a>五，部署master节点</h2><blockquote>
<p>kubernetes master 节点运行如下组件：</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager<br>kube-scheduler 和 kube-controller-manager 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。</li>
</ul>
</blockquote>
<h3 id="5-1-将二进制文件解压拷贝到master节点"><a href="#5-1-将二进制文件解压拷贝到master节点" class="headerlink" title="5.1 将二进制文件解压拷贝到master节点"></a>5.1 将二进制文件解压拷贝到master节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.13.0/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master01 ~]# tar xf kubernetes-server-linux-amd64.tar.gz -C /usr/src</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /usr/src/kubernetes/</span><br><span class="line">[root@k8s-master01 kubernetes]# <span class="built_in">cp</span> server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /k8s/kubernetes/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝证书文件</span></span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">cd</span> /k8s/k8s_ssl/</span><br><span class="line">[root@k8s-master01 k8s_ssl]# <span class="built_in">cp</span> *pem /k8s/kubernetes/ssl/</span><br></pre></td></tr></table></figure>

<h3 id="5-2-部署kube-apiserver组件"><a href="#5-2-部署kube-apiserver组件" class="headerlink" title="5.2 部署kube-apiserver组件"></a>5.2 部署kube-apiserver组件</h3><h4 id="5-2-1-创建TLS-Bootstrapping-Token"><a href="#5-2-1-创建TLS-Bootstrapping-Token" class="headerlink" title="5.2.1 创建TLS Bootstrapping Token"></a>5.2.1 创建TLS Bootstrapping Token</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span></span><br><span class="line">ae4d97f8d4a89cae9fedd4e5f8cf45a1</span><br><span class="line">[root@k8s-master01 ~]# vim /k8s/kubernetes/cfg/token.csv</span><br><span class="line">ae4d97f8d4a89cae9fedd4e5f8cf45a1,kubelet-bootstrap,10001,<span class="string">&quot;system:kubelet-bootstrap&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-创建apiserver配置文件"><a href="#5-2-2-创建apiserver配置文件" class="headerlink" title="5.2.2 创建apiserver配置文件"></a>5.2.2 创建apiserver配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /k8s/kubernetes/cfg/kube-apiserver</span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">&quot;--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--etcd-servers=https://192.168.101.61:2379,https://192.168.101.62:2379,https://192.168.101.125:2379 \</span></span><br><span class="line"><span class="string">--bind-address=192.168.101.61 \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--advertise-address=192.168.101.61 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span></span><br><span class="line"><span class="string">--authorization-mode=RBAC \</span></span><br><span class="line"><span class="string">--enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">--token-auth-file=/k8s/kubernetes/cfg/token.csv \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">--tls-cert-file=/k8s/kubernetes/ssl/kubernetes.pem  \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/k8s/kubernetes/ssl/kubernetes-key.pem \</span></span><br><span class="line"><span class="string">--client-ca-file=/k8s/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--etcd-cafile=/k8s/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--etcd-certfile=/k8s/etcd/ssl/server.pem \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#参数说明：</span></span><br><span class="line">--logtostderr：记录标准错误而不是文件。默认为 ture</span><br><span class="line">--v：日志级别详细程度的编号。</span><br><span class="line">--etcd-servers：要连接的etcd服务器列表(scheme://ip:port)，逗号分隔。</span><br><span class="line">--bind-address：要监听--secure-port端口的IP地址。关联的接口必须可由群集的其余部分以及CLI / Web客户端访问。如果为空，将使用所有接口（所有IPv4接口均为0.0.0.0，所有IPv6接口为::）。</span><br><span class="line">--secure-port：通过身份验证和授权为HTTPS提供服务的端口。无法使用0关闭。默认6443</span><br><span class="line">--advertise-address：用于群集成员访问apiserver的IP地址。该地址必须可由群集的其余部分访问。如果为空，则使用--bind-address。如果未指定--bind-address，将使用主机的默认接口。</span><br><span class="line">--allow-privileged：如果为<span class="literal">true</span>，则允许容器获取特权权限。[默认= FALSE]</span><br><span class="line">--service-cluster-ip-range：CIDR标记的IP范围，从中分配IP给服务集群。该范围不能与分配给Pod节点的任何IP范围重叠。</span><br><span class="line">--enable-admission-plugins：除了默认启用的插件之外还应启用的插件插件。</span><br><span class="line">--authorization-mode：在安全端口上执行授权的有序插件列表。以逗号分隔的列表：AlwaysAllow，AlwaysDeny，ABAC，Webhook，RBAC，Node。默认值：AlwaysAllow（授权访问类型。RBAC：基于角色的访问控制）</span><br><span class="line">--enable-bootstrap-token-auth：允许在<span class="string">&#x27;kube-system&#x27;</span>命名空间中允许类型为<span class="string">&#x27;bootstrap.kubernetes.io/token&#x27;</span>的机密用于TLS引导认证。</span><br><span class="line">--token-auth-file：如果设置，将用于通过令牌身份验证保护API服务器的安全端口的文件。（指定token文件路径）</span><br><span class="line">--service-node-port-range：为NodePort可见性的服务保留的端口范围。示例：<span class="string">&#x27;30000-50000&#x27;</span>。包括在范围的两端。</span><br><span class="line">--tls-cert-file：包含HTTPS的默认x509证书的文件。（CA证书，如果有的话，在服务器证书之后连接）。如果启用了HTTPS服务，并且未提供--tls-cert-file和--tls-private-key-file，则会为公共地址生成自签名证书和密钥，并将其保存到指定的目录中 --cert-dir。</span><br><span class="line">--tls-private-key-file：包含与--tls-cert-file匹配的默认x509私钥的文件。</span><br><span class="line">--client-ca-file：指定k8s集群CA证书路径。</span><br><span class="line">--service-account-key-file：指定k8s集群CA-key证书路径。</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-创建kube-apiserver-systemd-unit文件"><a href="#5-2-3-创建kube-apiserver-systemd-unit文件" class="headerlink" title="5.2.3 创建kube-apiserver systemd unit文件"></a>5.2.3 创建kube-apiserver systemd unit文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-apiserver <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="5-2-4-启动apiserver服务"><a href="#5-2-4-启动apiserver服务" class="headerlink" title="5.2.4 启动apiserver服务"></a>5.2.4 启动apiserver服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-apiserver.service to /usr/lib/systemd/system/kube-apiserver.service.</span><br><span class="line">[root@k8s-master01 ~]# systemctl restart kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看apiserver服务是否运行</span></span><br><span class="line">[root@k8s-master01 cfg]# ps -ef | grep kube-apiserver</span><br><span class="line">root     10051     1 99 14:28 ?        00:00:06 /k8s/kubernetes/bin/kube-apiserver --logtostderr=<span class="literal">true</span> --v=4 --etcd-servers=https://192.168.101.61:2379,https://192.168.101.62:2379,https://192.168.101.125:2379 --bind-address=192.168.101.61 --secure-port=6443 --advertise-address=192.168.101.61 --allow-privileged=<span class="literal">true</span> --service-cluster-ip-range=10.0.0.0/24 --enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction --authorization-mode=RBAC --enable-bootstrap-token-auth --token-auth-file=/k8s/kubernetes/cfg/token.csv --service-node-port-range=30000-50000 --tls-cert-file=/k8s/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/k8s/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/k8s/kubernetes/ssl/ca.pem --service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem --etcd-cafile=/k8s/etcd/ssl/ca.pem --etcd-certfile=/k8s/etcd/ssl/server.pem --etcd-keyfile=/k8s/etcd/ssl/server-key.pem</span><br><span class="line">root     10064  9023  0 14:28 pts/0    00:00:00 grep --color=auto kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="5-3-部署kube-controller-manager"><a href="#5-3-部署kube-controller-manager" class="headerlink" title="5.3 部署kube-controller-manager"></a>5.3 部署kube-controller-manager</h3><h4 id="5-3-1-创建kube-controller-manager配置文件"><a href="#5-3-1-创建kube-controller-manager配置文件" class="headerlink" title="5.3.1 创建kube-controller-manager配置文件"></a>5.3.1 创建kube-controller-manager配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /k8s/kubernetes/cfg/kube-controller-manager</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">&quot;--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--master=127.0.0.1:8080 \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/k8s/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/k8s/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">--root-ca-file=/k8s/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/k8s/kubernetes/ssl/ca-key.pem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line">--service-cluster-ip-range 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致；</span><br><span class="line">--cluster-signing-* 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥；</span><br><span class="line">--root-ca-file 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件；</span><br><span class="line">--address 服务监听地址。值必须为 127.0.0.1，kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器；</span><br><span class="line">--leader-elect：在执行主循环之前，启动领导者选举客户并获得领导。在运行复制组件以实现高可用性时启用此功能。默认值：<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="5-3-2-创建kube-controller-manager-systemd-unit文件"><a href="#5-3-2-创建kube-controller-manager-systemd-unit文件" class="headerlink" title="5.3.2 创建kube-controller-manager systemd unit文件"></a>5.3.2 创建kube-controller-manager systemd unit文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="5-3-3-启动kube-controller-manager服务"><a href="#5-3-3-启动kube-controller-manager服务" class="headerlink" title="5.3.3 启动kube-controller-manager服务"></a>5.3.3 启动kube-controller-manager服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">enable</span> kube-controller-manager</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service to /usr/lib/systemd/system/kube-controller-manager.service.</span><br><span class="line">[root@k8s-master01 ~]# systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务运行状态：</span></span><br><span class="line">[root@k8s-master01 ~]# /k8s/kubernetes/bin/kubectl get componentstatuses       <span class="comment">#启动每个组件后可以通过执行命令kubectl get componentstatuses，来查看各个组件的状态;</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">controller-manager   Healthy     ok         <span class="comment">#组件启动成功</span></span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">[root@k8s-master01 ~]# systemctl status kube-controller-manager</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 五 2019-04-19 15:01:59 CST; 1min 32s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 10984 (kube-controller)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   Memory: 29.2M</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─10984 /k8s/kubernetes/bin/kube-controller-manager --logtostderr=<span class="literal">true</span> --v=4 --master=127.0.0.1:8080 --leader-elect=<span class="literal">true</span> --address=127.0.0.1 --service-cluster-ip-range=10.0.0.0/24 --cluster-...</span><br><span class="line"></span><br><span class="line">4月 19 15:03:20 k8s-master01 kube-controller-manager[10984]: I0419 15:03:20.760802   10984 gc_controller.go:173] GC<span class="string">&#x27;ing unscheduled pods which are terminating.</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.693936   10984 cronjob_controller.go:111] Found 0 jobs</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.695533   10984 cronjob_controller.go:119] Found 0 cronjobs</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.695541   10984 cronjob_controller.go:122] Found 0 groups</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.727777   10984 reflector.go:215] k8s.io/client-go/informers/factory.go:132: forcing resync</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.728472   10984 reflector.go:215] k8s.io/client-go/informers/factory.go:132: forcing resync</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.734602   10984 reflector.go:215] k8s.io/client-go/informers/factory.go:132: forcing resync</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.734673   10984 reflector.go:215] k8s.io/client-go/informers/factory.go:132: forcing resync</span></span><br><span class="line"><span class="string">4月 19 15:03:30 k8s-master01 kube-controller-manager[10984]: I0419 15:03:30.793013   10984 pv_controller_base.go:408] resyncing PV controller</span></span><br><span class="line"><span class="string">4月 19 15:03:32 k8s-master01 kube-controller-manager[10984]: I0419 15:03:32.177901   10984 resource_quota_controller.go:422] no resource updates from discovery, skipping resource quota sync</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-部署kube-scheduler"><a href="#5-4-部署kube-scheduler" class="headerlink" title="5.4 部署kube-scheduler"></a>5.4 部署kube-scheduler</h3><h4 id="5-4-1-创建kube-scheduler配置文件"><a href="#5-4-1-创建kube-scheduler配置文件" class="headerlink" title="5.4.1 创建kube-scheduler配置文件"></a>5.4.1 创建kube-scheduler配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /k8s/kubernetes/cfg/kube-scheduler</span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">&quot;--logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line">--master Kubernetes API服务地址，如果kubeconfig中给定，则覆盖掉。</span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-创建kube-scheduler-systemd-unit-文件"><a href="#5-4-2-创建kube-scheduler-systemd-unit-文件" class="headerlink" title="5.4.2 创建kube-scheduler systemd unit 文件"></a>5.4.2 创建kube-scheduler systemd unit 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-scheduler <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="5-4-3-启动kube-scheduler服务"><a href="#5-4-3-启动kube-scheduler服务" class="headerlink" title="5.4.3 启动kube-scheduler服务"></a>5.4.3 启动kube-scheduler服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master01 ~]# systemctl <span class="built_in">enable</span> kube-scheduler</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-scheduler.service to /usr/lib/systemd/system/kube-scheduler.service.</span><br><span class="line">[root@k8s-master01 ~]# systemctl restart kube-scheduler</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看启动状态：（两个组件都ok了）</span></span><br><span class="line">[root@k8s-master01 ~]# /k8s/kubernetes/bin/kubectl get componentstatuses</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-给k8s的相关命令做软连接并给master授权"><a href="#5-5-给k8s的相关命令做软连接并给master授权" class="headerlink" title="5.5 给k8s的相关命令做软连接并给master授权"></a>5.5 给k8s的相关命令做软连接并给master授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">ln</span> -s /k8s/kubernetes/bin/* /usr/local/bin/</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">which</span> kubectl</span><br><span class="line">/usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进行master授权</span></span><br><span class="line">kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=system:anonymous</span><br></pre></td></tr></table></figure>

<h2 id="六，部署node节点"><a href="#六，部署node节点" class="headerlink" title="六，部署node节点"></a>六，部署node节点</h2><blockquote>
<p>kubernetes work 节点运行如下组件：</p>
<ul>
<li>docker 前面已经部署</li>
<li>flannel 前面已经部署</li>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</blockquote>
<h3 id="6-1-创建-kubelet-bootstrapping-kubeconfig-文件"><a href="#6-1-创建-kubelet-bootstrapping-kubeconfig-文件" class="headerlink" title="6.1 创建 kubelet bootstrapping kubeconfig 文件"></a>6.1 创建 kubelet bootstrapping kubeconfig 文件</h3><blockquote>
<ul>
<li>因为kubelet、kube-proxy 等 Node 机器上的进程与 Master 机器的 kube-apiserver 进程通信时需要认证和授权；所以创建kubernetes文件。</li>
<li>以下操作只需要在master节点上执行，生成的*.kubeconfig文件可以直接拷贝到node节点的&#x2F;k8s&#x2F;kubernetes&#x2F;cfg目录下。</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">export</span> BOOTSTRAP_TOKEN=ae4d97f8d4a89cae9fedd4e5f8cf45a1</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">export</span> KUBE_APISERVER=<span class="string">&quot;https://192.168.101.61:6443&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置集群参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">Cluster <span class="string">&quot;kubernetes&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置客户端认证参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">   --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">User <span class="string">&quot;kubelet-bootstrap&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置上下文参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kubelet-bootstrap \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">Context <span class="string">&quot;default&quot;</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置默认上下文</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">Switched to context <span class="string">&quot;default&quot;</span>.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>–embed-certs 为 true 时表示将 certificate-authority 证书写入到生成的 bootstrap.kubeconfig 文件中；<br>设置客户端认证参数时没有指定秘钥和证书，后续由 kube-apiserver 自动生成；</p>
</blockquote>
<h3 id="6-2-创建-kube-proxy-kubeconfig-文件"><a href="#6-2-创建-kube-proxy-kubeconfig-文件" class="headerlink" title="6.2 创建 kube-proxy kubeconfig 文件"></a>6.2 创建 kube-proxy kubeconfig 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">    --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Cluster <span class="string">&quot;kubernetes&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-credentials kube-proxy \</span><br><span class="line">   --client-certificate=/k8s/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">   --client-key=/k8s/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">User <span class="string">&quot;kube-proxy&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config set-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kube-proxy \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Context <span class="string">&quot;default&quot;</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Switched to context <span class="string">&quot;default&quot;</span>.</span><br></pre></td></tr></table></figure>

<h3 id="6-3-分发-kubeconfig-文件"><a href="#6-3-分发-kubeconfig-文件" class="headerlink" title="6.3 分发 kubeconfig 文件"></a>6.3 分发 kubeconfig 文件</h3><blockquote>
<p>将两个 kubeconfig 文件分发到所有 Node 机器的 &#x2F;k8s&#x2F;kubernetes&#x2F;cfg&#x2F; 目录</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> bootstrap.kubeconfig /k8s/kubernetes/cfg/</span><br><span class="line">[root@k8s-master01 ~]# <span class="built_in">mv</span> kube-proxy.kubeconfig /k8s/kubernetes/cfg/</span><br><span class="line">[root@k8s-master01 ~]# scp /k8s/kubernetes/cfg/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; 192.168.101.62:/k8s/kubernetes/cfg/</span><br><span class="line">bootstrap.kubeconfig                                                                                                                                                      100% 2168     4.9MB/s   00:00</span><br><span class="line">kube-proxy.kubeconfig                                                                                                                                                     100% 6274    13.6MB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /k8s/kubernetes/cfg/&#123;bootstrap.kubeconfig,kube-proxy.kubeconfig&#125; 192.168.101.125:/k8s/kubernetes/cfg/</span><br><span class="line">bootstrap.kubeconfig                                                                                                                                                      100% 2168     4.4MB/s   00:00</span><br><span class="line">kube-proxy.kubeconfig                                                                                                                                                     100% 6274    11.8MB/s   00:00</span><br></pre></td></tr></table></figure>

<h3 id="6-4-分发kubelet和kube-proxy命令"><a href="#6-4-分发kubelet和kube-proxy命令" class="headerlink" title="6.4 分发kubelet和kube-proxy命令"></a>6.4 分发kubelet和kube-proxy命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# scp /k8s/kubernetes/bin/&#123;kubelet,kube-proxy&#125; 192.168.101.62:/k8s/kubernetes/bin/</span><br><span class="line">kubelet                                                                                                                                                                   100%  108MB 149.3MB/s   00:00</span><br><span class="line">kube-proxy                                                                                                                                                                100%   33MB 149.6MB/s   00:00</span><br><span class="line">[root@k8s-master01 ~]# scp /k8s/kubernetes/bin/&#123;kubelet,kube-proxy&#125; 192.168.101.125:/k8s/kubernetes/bin/</span><br><span class="line">kubelet                                                                                                                                                                   100%  108MB 128.2MB/s   00:00</span><br><span class="line">kube-proxy                                                                                                                                                                100%   33MB 145.2MB/s   00:00</span><br></pre></td></tr></table></figure>

<h3 id="6-5-创建-kubelet-参数配置模板文件"><a href="#6-5-创建-kubelet-参数配置模板文件" class="headerlink" title="6.5 创建 kubelet 参数配置模板文件"></a>6.5 创建 kubelet 参数配置模板文件</h3><blockquote>
<p>两台node机器同样操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# vim /k8s/kubernetes/cfg/kubelet.config</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 192.168.101.61</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [<span class="string">&quot;10.0.0.2&quot;</span>]</span><br><span class="line">clusterDomain: cluster.local.</span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>创建kubelet配置文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# vim /k8s/kubernetes/cfg/kubelet</span><br><span class="line">KUBELET_OPTS=<span class="string">&quot;--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.101.61 \</span></span><br><span class="line"><span class="string">--kubeconfig=/k8s/kubernetes/cfg/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/k8s/kubernetes/cfg/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">--config=/k8s/kubernetes/cfg/kubelet.config \</span></span><br><span class="line"><span class="string">--cert-dir=/k8s/kubernetes/ssl \</span></span><br><span class="line"><span class="string">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>创建kubelet systemd unit 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# vim /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/k8s/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kubelet <span class="variable">$KUBELET_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>将kubelet-bootstrap用户绑定到系统集群角色（master机器）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master 机器操作(创建集群角色)：</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">   --clusterrole=system:node-bootstrapper \</span><br><span class="line">   --group=system:nodes</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除集群角色方法：</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl delete clusterrolebinding/kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p><strong>启动服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-node01 ~]# systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service.</span><br><span class="line">[root@k8s-node01 ~]# systemctl restart kubelet</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>master端授权node节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master端查看csr</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get csr</span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-Bw88ux21GTp7OhJoJpyUUgdwnh6GlClymloIqGEra3c   7m7s    kubelet-bootstrap   Pending</span><br><span class="line">node-csr-ku4FxcEcbrcdCdKvUapH3MS21VRypJw8jrFZcS5LctE   6m57s   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权approve kubelet CSR 请求</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl certificate approve node-csr-Bw88ux21GTp7OhJoJpyUUgdwnh6GlClymloIqGEra3c</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-Bw88ux21GTp7OhJoJpyUUgdwnh6GlClymloIqGEra3c approved</span><br><span class="line">[root@k8s-master01 ~]# kubectl certificate approve node-csr-ku4FxcEcbrcdCdKvUapH3MS21VRypJw8jrFZcS5LctE</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-ku4FxcEcbrcdCdKvUapH3MS21VRypJw8jrFZcS5LctE approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看csr</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get csr</span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-Bw88ux21GTp7OhJoJpyUUgdwnh6GlClymloIqGEra3c   8m55s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-ku4FxcEcbrcdCdKvUapH3MS21VRypJw8jrFZcS5LctE   8m45s   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除多余csr方法</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]# kubectl delete csr [csr名称]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get node</span><br><span class="line">NAME              STATUS   ROLES    AGE   VERSION</span><br><span class="line">192.168.101.125   Ready    &lt;none&gt;   16h   v1.13.0</span><br><span class="line">192.168.101.62    Ready    &lt;none&gt;   16h   v1.13.0</span><br></pre></td></tr></table></figure>

<h3 id="6-6-部署-kube-proxy-组件"><a href="#6-6-部署-kube-proxy-组件" class="headerlink" title="6.6 部署 kube-proxy 组件"></a>6.6 部署 kube-proxy 组件</h3><blockquote>
<p>kube-proxy 运行在所有 node节点上，它监听 apiserver 中 service 和 Endpoint 的变化情况，创建路由规则来进行服务负载均衡。</p>
</blockquote>
<h4 id="6-6-1-创建-kube-proxy-配置文件"><a href="#6-6-1-创建-kube-proxy-配置文件" class="headerlink" title="6.6.1 创建 kube-proxy 配置文件"></a>6.6.1 创建 kube-proxy 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# vim /k8s/kubernetes/cfg/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">&quot;--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.101.62 \</span></span><br><span class="line"><span class="string">--cluster-cidr=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--kubeconfig=/k8s/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：</span></span><br><span class="line">--hostname-override：本机节点ip</span><br><span class="line">--kubeconfig：包含授权信息的 kubeconfig 文件的路径</span><br></pre></td></tr></table></figure>

<h4 id="6-6-2-创建kube-proxy-systemd-unit文件"><a href="#6-6-2-创建kube-proxy-systemd-unit文件" class="headerlink" title="6.6.2 创建kube-proxy systemd unit文件"></a>6.6.2 创建kube-proxy systemd unit文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node01 ~]# vim /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/k8s/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/k8s/kubernetes/bin/kube-proxy <span class="variable">$KUBE_PROXY_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="6-6-3-启动kube-proxy服务"><a href="#6-6-3-启动kube-proxy服务" class="headerlink" title="6.6.3 启动kube-proxy服务"></a>6.6.3 启动kube-proxy服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br><span class="line">systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务状态</span></span><br><span class="line">[root@k8s-node01 ~]# systemctl status kube-proxy</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 二 2019-04-23 10:15:09 CST; 25s ago</span><br><span class="line"> Main PID: 880 (kube-proxy)</span><br><span class="line">    Tasks: 0</span><br><span class="line">   Memory: 11.0M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           ‣ 880 /k8s/kubernetes/bin/kube-proxy --logtostderr=<span class="literal">true</span> --v=4 --hostname-override=192.168.101.62 --cluster-cidr=10.0.0.0/24 --kubeconfig=/k8s/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">4月 23 10:15:26 k8s-node01 kube-proxy[880]: I0423 10:15:26.484711     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:26 k8s-node01 kube-proxy[880]: I0423 10:15:26.486098     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:28 k8s-node01 kube-proxy[880]: I0423 10:15:28.492244     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:28 k8s-node01 kube-proxy[880]: I0423 10:15:28.492271     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:30 k8s-node01 kube-proxy[880]: I0423 10:15:30.500034     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:30 k8s-node01 kube-proxy[880]: I0423 10:15:30.501511     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:32 k8s-node01 kube-proxy[880]: I0423 10:15:32.508419     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:32 k8s-node01 kube-proxy[880]: I0423 10:15:32.508444     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:34 k8s-node01 kube-proxy[880]: I0423 10:15:34.513354     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br><span class="line">4月 23 10:15:34 k8s-node01 kube-proxy[880]: I0423 10:15:34.514406     880 config.go:141] Calling handler.OnEndpointsUpdate</span><br></pre></td></tr></table></figure>

<h3 id="6-7-集群状态"><a href="#6-7-集群状态" class="headerlink" title="6.7 集群状态"></a>6.7 集群状态</h3><blockquote>
<p>打开node节点集群标签</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl label node 192.168.101.62 node-role.kubernetes.io/node=<span class="string">&#x27;node&#x27;</span></span><br><span class="line">node/192.168.101.62 labeled</span><br><span class="line">[root@k8s-master01 ~]# kubectl label node 192.168.101.125 node-role.kubernetes.io/node=<span class="string">&#x27;node&#x27;</span></span><br><span class="line">node/192.168.101.125 labeled</span><br><span class="line">[root@k8s-master01 ~]# kubectl get node</span><br><span class="line">NAME              STATUS   ROLES   AGE   VERSION</span><br><span class="line">192.168.101.125   Ready    node    17h   v1.13.0</span><br><span class="line">192.168.101.62    Ready    node    17h   v1.13.0</span><br><span class="line">[root@k8s-master01 ~]# kubectl get node,cs</span><br><span class="line">NAME                   STATUS   ROLES   AGE   VERSION</span><br><span class="line">node/192.168.101.125   Ready    node    17h   v1.13.0</span><br><span class="line">node/192.168.101.62    Ready    node    17h   v1.13.0</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE             ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok</span><br><span class="line">componentstatus/controller-manager   Healthy   ok</span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">componentstatus/etcd-2               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">componentstatus/etcd-1               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#附录：master集群打开标签方法：</span></span><br><span class="line">举例：</span><br><span class="line">[root@k8s-master01 ~]# kubectl label node 192.168.101.62 node-role.kubernetes.io/master=<span class="string">&#x27;master&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此，k8s集群搭建完毕。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io">Kkabuzs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/">https://kkabuzs.github.io/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://kkabuzs.github.io" target="_blank">kkabuzs博客屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post-share"><div class="social-share" data-image="/themes-img/touxiang.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/articles/2019/04/02/Linux-fei-root-yonghushiyong-docker-dewenti/" title="Linux 下非root用户使用docker的问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Linux 下非root用户使用docker的问题</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  一，解决非root用户使用docker Linux 下非root用户使用docker，如果不需要root权限的话，需要将用户加入到docker组。  12#报错：ERROR: Couldn&#x27;t connect to Docker daemon at http+docker://localunixsocket - is it running?  通常我们使用linux系统的时候，最好是不要直接使用root账号，但是使用Docker的时候，默认又是不能使用非root用户的，关于原因，官方说法如下：   The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can access it with sudo. For...</div></div></div></a><a class="pagination-related" href="/articles/2019/04/23/rong-qi-zhanman-cipan-fuwuqi-he-rongqi-doumeidawenjian/" title="容器占满了磁盘，但虚机和容器内都没有找到大文件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">容器占满了磁盘，但虚机和容器内都没有找到大文件</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  一，原因阐述 领导让我排查一下aws服务器磁盘空间已满的问题，但是看不到大文件的存在，看下图：  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697#看根下所有目录的空间占用[root@gago-viirs gago_viirs]# cd /[root@gago-viirs /]# du -sh *0	bin49M	boot0	data0	dev31M	etc52K	home0	lib0	lib640	local0	media2.7G	mnt104K	optdu:...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/articles/2018/12/28/kubernetesyamlbushujixiefadingyi/" title="kubernetes yaml部署及各种yaml写法和含义"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-12-28</div><div class="info-item-2">kubernetes yaml部署及各种yaml写法和含义</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  kubernetes yaml部署及各种yaml写法和含义一，环境介绍   主机名 IP地址 CPU 内存 描述    k8s-master01 192.168.101.61 2核 4GB k8s master   k8s-node01 192.168.101.62 2核 4GB k8s node节点   k8s-node02 192.168.101.125 2核 4GB k8s node节点   二，RC的写法及SVC(service)的写法及用法2.1 创建一个mysql的RC123456789101112131415161718192021222324252627[root@k8s-master01 kubernetes-yaml]# pwd/root/kubernetes-yaml[root@k8s-master01 kubernetes-yaml]# vim msyql-rc.yamlapiVersion:...</div></div></div></a><a class="pagination-related" href="/articles/2018/11/21/kuberneteszhivolumeguazai/" title="Kubernetes之Volume挂载"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-21</div><div class="info-item-2">Kubernetes之Volume挂载</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Kubernetes之Volume挂载一，Volume Container中的磁盘文件是短暂的，这在容器中运行时会给非平凡的应用程序带来一些问题。首先，当容器崩溃时，kubelet将重新启动它，但文件将丢失，Container以干净状态启动。其次，当在一起运行Container时，Pod通常需要在这些容器之间共享文件。Kubernetes Volume抽象解决了这两个问题。  1.1...</div></div></div></a><a class="pagination-related" href="/articles/2019/07/01/centos7shiyongkubeadmbushukubernetes1-14-1jiqun/" title="CentOS 7 使用kubeadm部署kubernetes 1.14.1集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-01</div><div class="info-item-2">CentOS 7 使用kubeadm部署kubernetes 1.14.1集群</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  CentOS 7 使用kubeadm部署kubernetes 1.14.1集群一，主机清单   主机名 ip 描述 版本    gago-k8s-master 192.168.8.77 master节点 v1.14.1   gago-k8s-node1 192.168.8.174 node节点 v1.14.1   gago-k8s-node2 192.168.8.227 node节点 v1.14.1   gago-k8s-node3 192.168.8.84 node节点 v1.14.1   二，版本信息1234567# Linux发行版信息[root@gago-k8s-master ~]# cat /etc/redhat-release CentOS Linux release 7.2.1511 (Core) # Linux内核[root@gago-k8s-master ~]# uname...</div></div></div></a><a class="pagination-related" href="/articles/2019/06/18/jiejue-kubernetes-buneng-harbor-pull-images/" title="解决kubernetes不能从harbor pull image"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-06-18</div><div class="info-item-2">解决kubernetes不能从harbor pull image</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。   在实现kubernetes ci的时候发现node节点不能从harbor的私有仓库将image直接pull下来。但是直接从node节点直接pull的话又是没有问题的，后来发现如果想要kubernetes直接pull的话需要一个secret。  一，以下面的为例介绍 下面的是创建service以及deployment的例子  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748apiVersion: v1kind: Namespacemetadata:  name: test---apiVersion: v1kind: Servicemetadata:  name: webapp  namespace: test  labels:    app: nginxspec:  ports:  - port: 80  ...</div></div></div></a><a class="pagination-related" href="/articles/2019/07/04/k8s-apiserver-zhengshulunhuangengxin-kubeadm/" title="k8s apiserver证书轮换更新（kubeadm）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-04</div><div class="info-item-2">k8s apiserver证书轮换更新（kubeadm）</div></div><div class="info-2"><div class="info-item-1">一，确认kubeadm版本 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。   如果使用的事kubeadm 1.8之前的版本，那么需要手动更新证书。或者重建集群。或者升级为1.8版本之后，即可使用命令轮换更新。  12345#kubeadm更新方法示例：$ sudo curl -sSL https://dl.k8s.io/release/v1.8.15/bin/linux/amd64/kubeadm &gt; ./kubeadm.1.8.15$ chmod a+rx kubeadm.1.8.15$ sudo mv /usr/bin/kubeadm /usr/bin/kubeadm.1.7$ sudo mv kubeadm.1.8.15 /usr/bin/kubeadm  二，更新证书流程 因我的kubeadm版本为1.9，故不需要更新。  2.1 备份旧的apiserver，apiserver-kubelet-client和前端代理客户端证书和密钥。123456$ sudo mv...</div></div></div></a><a class="pagination-related" href="/articles/2019/08/12/kuberneteszhiStatefulSet/" title="Kubernetes之StatefulSet（有状态）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-08-12</div><div class="info-item-2">Kubernetes之StatefulSet（有状态）</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Kubernetes之StatefulSet（有状态）一，StatefulSet概述 statefulset是kubernetes提供的管理有状态应用的负载管理控制器API在pod管理的基础上保证pod的顺序和一致性与部署一样statefulset也是使用容器的spec来创建pod与之不同的是statefulset创建的pod在生命周期中会保持持久的标记比如pod name  1.1 前提 Kubernetes集群的版本 &gt;&#x3D;1.5 安装好DNS集群插件，版本 &gt;&#x3D;15  1.2 特点 StatefulSet(1.5版本之前叫做PetSet)为什么适合有状态的程序，因为它相比于Deployment有以下特点：  稳定的，唯一的网络标识，可以用来发现集群内部的其他成员。比如StatefulSet的名字叫kafka,那么第一个起来的Pet叫kafka-0,第二个叫...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Kkabuzs</div><div class="author-info-description">学习记录和整理</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">三人行，必有我师！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CentOS-7-%E4%BD%BF%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-Kubernetes-1-13%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">CentOS 7 使用二进制部署 Kubernetes 1.13集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%EF%BC%8C%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一，概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 架构图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes-1-13%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.</span> <span class="toc-text">二，二进制部署kubernetes 1.13集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 安装环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%88%9B%E5%BB%BA%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 创建安装目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AECFSSL"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 安装及配置CFSSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%88%9B%E5%BB%BA%E8%AE%A4%E8%AF%81%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 创建认证证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E5%88%9B%E5%BB%BA-ETCD-CA-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">2.5.1 创建 ETCD CA 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E5%88%9B%E5%BB%BAETCD-CA-%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">2.5.2 创建ETCD CA 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3-%E5%88%9B%E5%BB%BAETCD-server-%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">2.5.3 创建ETCD server 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-4-%E7%94%9F%E6%88%90ETCD-CA-%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%98%E9%92%A5"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">2.5.4 生成ETCD CA 证书和秘钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-5-%E5%88%9B%E5%BB%BAKubernetes-CA-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.5.5.</span> <span class="toc-text">2.5.5 创建Kubernetes CA 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-6-%E5%88%9B%E5%BB%BAKubernetes-CA-%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.6.</span> <span class="toc-text">2.5.6 创建Kubernetes CA 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-7-%E5%88%9B%E5%BB%BAkubernetes%EF%BC%88api-server%EF%BC%89%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.7.</span> <span class="toc-text">2.5.7 创建kubernetes（api server）证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-8-%E5%88%9B%E5%BB%BAkubernetes-proxy-%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.8.</span> <span class="toc-text">2.5.8 创建kubernetes proxy 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-9-%E6%A0%A1%E9%AA%8C%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.5.9.</span> <span class="toc-text">2.5.9 校验证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E4%B8%89%E5%8F%B0%E6%9C%BA%E5%99%A8%E7%9B%B8%E4%BA%92ssh-key%E5%85%8D%E5%AF%86%E9%92%A5"><span class="toc-number">1.2.6.</span> <span class="toc-text">2.6 三台机器相互ssh-key免密钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%EF%BC%8C%E9%83%A8%E7%BD%B2ETCD%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.</span> <span class="toc-text">三，部署ETCD集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 解压安装文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BA-etcd-%E7%9A%84-systemd-unit-%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 创建 etcd 的 systemd unit 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%88%9B%E5%BB%BAetcd%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 创建etcd的环境变量配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 拷贝证书文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%B0%86%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E5%88%B0%E8%8A%82%E7%82%B962%E3%80%81%E8%8A%82%E7%82%B9125"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 将启动文件、配置文件拷贝到节点62、节点125</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E5%90%AF%E5%8A%A8ETCD%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.6.</span> <span class="toc-text">3.6 启动ETCD集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8C%E9%83%A8%E7%BD%B2-Flannel-%E7%BD%91%E7%BB%9C"><span class="toc-number">1.4.</span> <span class="toc-text">四，部署 Flannel 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%90%91-ETCD-%E5%86%99%E5%85%A5%E9%9B%86%E7%BE%A4-Pod-%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 向 ETCD 写入集群 Pod 信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85Flannel"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 解压安装Flannel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%85%8D%E7%BD%AEFlannel"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 配置Flannel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%88%9B%E5%BB%BAFlannel%E7%9A%84systemd-unit%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 创建Flannel的systemd unit文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%85%8D%E7%BD%AEdocker%E5%90%AF%E5%8A%A8%EF%BC%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%90%E7%BD%91%E7%BD%91%E6%AE%B5"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 配置docker启动，自定义子网网段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E5%B0%86flanneld-systemd-unit-%E6%96%87%E4%BB%B6%E5%88%B0%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.6.</span> <span class="toc-text">4.6 将flanneld systemd unit 文件到所有节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%EF%BC%8C%E9%83%A8%E7%BD%B2master%E8%8A%82%E7%82%B9"><span class="toc-number">1.5.</span> <span class="toc-text">五，部署master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%B0%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E8%A7%A3%E5%8E%8B%E6%8B%B7%E8%B4%9D%E5%88%B0master%E8%8A%82%E7%82%B9"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 将二进制文件解压拷贝到master节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E9%83%A8%E7%BD%B2kube-apiserver%E7%BB%84%E4%BB%B6"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 部署kube-apiserver组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E5%88%9B%E5%BB%BATLS-Bootstrapping-Token"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">5.2.1 创建TLS Bootstrapping Token</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%88%9B%E5%BB%BAapiserver%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">5.2.2 创建apiserver配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-%E5%88%9B%E5%BB%BAkube-apiserver-systemd-unit%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">5.2.3 创建kube-apiserver systemd unit文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-%E5%90%AF%E5%8A%A8apiserver%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.2.4 启动apiserver服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E9%83%A8%E7%BD%B2kube-controller-manager"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.3 部署kube-controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-%E5%88%9B%E5%BB%BAkube-controller-manager%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">5.3.1 创建kube-controller-manager配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E5%88%9B%E5%BB%BAkube-controller-manager-systemd-unit%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">5.3.2 创建kube-controller-manager systemd unit文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-%E5%90%AF%E5%8A%A8kube-controller-manager%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">5.3.3 启动kube-controller-manager服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E9%83%A8%E7%BD%B2kube-scheduler"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.4 部署kube-scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-%E5%88%9B%E5%BB%BAkube-scheduler%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">5.4.1 创建kube-scheduler配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E5%88%9B%E5%BB%BAkube-scheduler-systemd-unit-%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">5.4.2 创建kube-scheduler systemd unit 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-3-%E5%90%AF%E5%8A%A8kube-scheduler%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">5.4.3 启动kube-scheduler服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E7%BB%99k8s%E7%9A%84%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5%E5%B9%B6%E7%BB%99master%E6%8E%88%E6%9D%83"><span class="toc-number">1.5.6.</span> <span class="toc-text">5.5 给k8s的相关命令做软连接并给master授权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%EF%BC%8C%E9%83%A8%E7%BD%B2node%E8%8A%82%E7%82%B9"><span class="toc-number">1.6.</span> <span class="toc-text">六，部署node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%88%9B%E5%BB%BA-kubelet-bootstrapping-kubeconfig-%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 创建 kubelet bootstrapping kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%88%9B%E5%BB%BA-kube-proxy-kubeconfig-%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 创建 kube-proxy kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%88%86%E5%8F%91-kubeconfig-%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 分发 kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%88%86%E5%8F%91kubelet%E5%92%8Ckube-proxy%E5%91%BD%E4%BB%A4"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 分发kubelet和kube-proxy命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E5%88%9B%E5%BB%BA-kubelet-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 创建 kubelet 参数配置模板文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%83%A8%E7%BD%B2-kube-proxy-%E7%BB%84%E4%BB%B6"><span class="toc-number">1.6.6.</span> <span class="toc-text">6.6 部署 kube-proxy 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-1-%E5%88%9B%E5%BB%BA-kube-proxy-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">6.6.1 创建 kube-proxy 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-2-%E5%88%9B%E5%BB%BAkube-proxy-systemd-unit%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">6.6.2 创建kube-proxy systemd unit文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-3-%E5%90%AF%E5%8A%A8kube-proxy%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.6.3.</span> <span class="toc-text">6.6.3 启动kube-proxy服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">1.6.7.</span> <span class="toc-text">6.7 集群状态</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fenpianjiqun/" title="MongoDB-6.0.21离线分片集群部署">MongoDB-6.0.21离线分片集群部署</a><time datetime="2025-04-21T17:53:44.000Z" title="发表于 2025-04-22 01:53:44">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fubenjibushu/" title="MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式">MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式</a><time datetime="2025-04-21T17:51:21.000Z" title="发表于 2025-04-22 01:51:21">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/21/mongodb-6-0-21-lixian-danjiedianbushu/" title="MongoDB-6.0.21离线单节点部署">MongoDB-6.0.21离线单节点部署</a><time datetime="2025-04-21T15:55:06.000Z" title="发表于 2025-04-21 23:55:06">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/10/jichengyupaisheng/" title="继承与派生">继承与派生</a><time datetime="2023-05-10T05:52:52.000Z" title="发表于 2023-05-10 13:52:52">2023-05-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/09/fengzhuang/" title="封装">封装</a><time datetime="2023-05-09T01:37:55.000Z" title="发表于 2023-05-09 09:37:55">2023-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Kkabuzs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>