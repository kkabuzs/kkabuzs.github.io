<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Ubuntu16.04快速构建kubernetes测试集群 | kkabuzs博客屋</title><meta name="author" content="Kkabuzs"><meta name="copyright" content="Kkabuzs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ubuntu16.04快速构建kubernetes测试集群一，kubernetes的基本框架和基本概念1.1 k8s是什么？为什么使用k8s？ kubernetes是Google（基于borg）开源的容器集群管理系统，其提供应用部署，维护，扩展机制等功能，利用kubernetes能方便的管理跨机器运行的容器化应用，其主要功能如下：  使用Docker对应用程序包装（package），实例化（ins">
<meta property="og:type" content="article">
<meta property="og:title" content="Ubuntu16.04快速构建kubernetes测试集群">
<meta property="og:url" content="https://kkabuzs.github.io/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/index.html">
<meta property="og:site_name" content="kkabuzs博客屋">
<meta property="og:description" content="Ubuntu16.04快速构建kubernetes测试集群一，kubernetes的基本框架和基本概念1.1 k8s是什么？为什么使用k8s？ kubernetes是Google（基于borg）开源的容器集群管理系统，其提供应用部署，维护，扩展机制等功能，利用kubernetes能方便的管理跨机器运行的容器化应用，其主要功能如下：  使用Docker对应用程序包装（package），实例化（ins">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg">
<meta property="article:published_time" content="2018-11-22T01:43:48.000Z">
<meta property="article:modified_time" content="2018-11-22T01:43:48.000Z">
<meta property="article:author" content="Kkabuzs">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ubuntu16.04快速构建kubernetes测试集群",
  "url": "https://kkabuzs.github.io/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/",
  "image": "https://kkabuzs.github.io/themes-img/touxiang.jpg",
  "datePublished": "2018-11-22T01:43:48.000Z",
  "dateModified": "2018-11-22T01:43:48.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kkabuzs",
      "url": "https://kkabuzs.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/themes-img/touxiang.jpg"><link rel="canonical" href="https://kkabuzs.github.io/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ubuntu16.04快速构建kubernetes测试集群',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/themes-img/yinhe.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/themes-img/touxiang.jpg" alt="Logo"><span class="site-name">kkabuzs博客屋</span></a><a class="nav-page-title" href="/"><span class="site-name">Ubuntu16.04快速构建kubernetes测试集群</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Ubuntu16.04快速构建kubernetes测试集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-11-22T01:43:48.000Z" title="发表于 2018-11-22 09:43:48">2018-11-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2018-11-22T01:43:48.000Z" title="更新于 2018-11-22 09:43:48">2018-11-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Ubuntu/">Ubuntu</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Ubuntu16-04快速构建kubernetes测试集群"><a href="#Ubuntu16-04快速构建kubernetes测试集群" class="headerlink" title="Ubuntu16.04快速构建kubernetes测试集群"></a>Ubuntu16.04快速构建kubernetes测试集群</h1><h2 id="一，kubernetes的基本框架和基本概念"><a href="#一，kubernetes的基本框架和基本概念" class="headerlink" title="一，kubernetes的基本框架和基本概念"></a>一，kubernetes的基本框架和基本概念</h2><h3 id="1-1-k8s是什么？为什么使用k8s？"><a href="#1-1-k8s是什么？为什么使用k8s？" class="headerlink" title="1.1 k8s是什么？为什么使用k8s？"></a>1.1 k8s是什么？为什么使用k8s？</h3><blockquote>
<p>kubernetes是Google（基于borg）开源的容器集群管理系统，其提供应用部署，维护，扩展机制等功能，利用kubernetes能方便的管理跨机器运行的容器化应用，其主要功能如下：</p>
<ul>
<li>使用Docker对应用程序包装（package），实例化（instantiate），运行（run）。</li>
<li>以集群的方式运行，管理跨机器的容器。</li>
<li>解决Docker跨机器容器之间的通讯问题。</li>
<li>Kubernetes的自我修复机制使得容器集群总是运行在用户期望的状态。</li>
</ul>
</blockquote>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/1.png"></p>
<p><strong>为什么使用？</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 开发人员各司其职，轻装上阵。（架构师负责服务器组件提炼，开发工程师负责业务代码的开发，运维或系统工程师负责部署与运维）</li>
<li><input checked="" disabled="" type="checkbox"> 全面拥抱微服务框架。</li>
<li><input checked="" disabled="" type="checkbox"> 使用kubernetes我们系统可以随时的整体迁移。</li>
<li><input checked="" disabled="" type="checkbox"> kubernetes系统具备了超强的横向扩容能力。</li>
</ul>
<h3 id="1-2-kubernetes概念"><a href="#1-2-kubernetes概念" class="headerlink" title="1.2 kubernetes概念"></a>1.2 kubernetes概念</h3><h4 id="1-2-1-Master"><a href="#1-2-1-Master" class="headerlink" title="1.2.1 Master"></a>1.2.1 Master</h4><blockquote>
<p>集群控制节点，master节点上运行着一组关键的进程。</p>
</blockquote>
<ul>
<li>Kubernetes API Server（Kube-apiserver）：提供HTTP Rest接口的关键服务程序，kubernetes里所有资源增，删，改，查等操作的唯一入口，也是集群控制程序的入口进程。</li>
<li>Kubernetes Controller Manager（Kube-controller-manager）：所有资源对象的自动化控制中心。（资源对象的大总管）</li>
<li>Kubernetes Scheduler（Kube-scheduler）：资源调度（pod）的进程。（调度室）</li>
<li>etcd Server：Kubernetes里所有资源对象的数据全部都是保持在etcd中</li>
</ul>
<h4 id="1-2-2-Node"><a href="#1-2-2-Node" class="headerlink" title="1.2.2 Node"></a>1.2.2 Node</h4><blockquote>
<p>Node是Master而言的工作主机，可以使物理主机，VM等。运行Kubelet，Kube-proxy和docker Engine。</p>
</blockquote>
<ul>
<li>Kubelet：pod对应容器的创建，暂停等任务。</li>
<li>Kube-proxy：K8s server的通信与负载均衡机制的重要组件。</li>
<li>Docker Engine：docker引擎，本机容器的创建与管理。</li>
</ul>
<h4 id="1-2-3-Pods"><a href="#1-2-3-Pods" class="headerlink" title="1.2.3 Pods"></a>1.2.3 Pods</h4><blockquote>
<p>最小部署单元，可包含多个容器，是连接在一起的容器组合并共享文件卷。它们是最小的部署单元，由Kubernetes统一创建，调度，管理。Pods是可以直接创建的，但推荐的做法是使用Replication Controller，即使是创建一个Pod。</p>
</blockquote>
<h4 id="1-2-4-Labels（标签）"><a href="#1-2-4-Labels（标签）" class="headerlink" title="1.2.4 Labels（标签）"></a>1.2.4 Labels（标签）</h4><blockquote>
<p>Lables（标签）以key（键）&#x2F;value（值）形式附加到Pods，Service，RC，Node等上面，每个对象可以定义多个label，以提供Label Selector（标签选择器）来选择对象，Label Selector有两种形式：</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 基于等式：name&#x3D;redis-slave选择k&#x2F;v都是相等的，env！&#x3D;production选择k&#x3D;env，但是v！&#x3D;production。</li>
<li><input checked="" disabled="" type="checkbox"> 基于集合：name [not] in (redis-master，redis-slave)，类似于SQL中的in。</li>
</ul>
</blockquote>
<h4 id="1-2-5-Replication-controllers（复制控制器）"><a href="#1-2-5-Replication-controllers（复制控制器）" class="headerlink" title="1.2.5 Replication controllers（复制控制器）"></a>1.2.5 Replication controllers（复制控制器）</h4><blockquote>
<p>管理Pods的生命周期。它们确保指定数量的Pods会一直运行，还有实现资源伸缩。</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 定义RC实现Pod的创建与副本数量的自动控制。</li>
<li><input checked="" disabled="" type="checkbox"> RC通过Lable Selector机制实现对副本的自动控制。</li>
<li><input checked="" disabled="" type="checkbox"> 通过改变RC的Pod副本数量，实现Pod的扩容或缩容。</li>
<li><input checked="" disabled="" type="checkbox"> 通过改变RC里Pod模板中的镜像版本，实现Pod的滚动更新。</li>
</ul>
</blockquote>
<h4 id="1-2-6-Deployment（部署）"><a href="#1-2-6-Deployment（部署）" class="headerlink" title="1.2.6 Deployment（部署）"></a>1.2.6 Deployment（部署）</h4><blockquote>
<p>1.2版本引入，为了更好的解决Pod的编排问题，内部使用了Replication controllers实现；它相对于RC最大的升级就是可以随时知道当前Pod部署的进度。</p>
</blockquote>
<h4 id="1-2-7-Horizontal-Pod-Autocaler（HPA）"><a href="#1-2-7-Horizontal-Pod-Autocaler（HPA）" class="headerlink" title="1.2.7 Horizontal Pod Autocaler（HPA）"></a>1.2.7 Horizontal Pod Autocaler（HPA）</h4><blockquote>
<p>Pod横向自动扩容，通过追踪分析RC控制的所有目标Pod的负载变化情况，确定是否需要针对性的调整目标Pod副本数。</p>
</blockquote>
<h4 id="1-2-8-Services"><a href="#1-2-8-Services" class="headerlink" title="1.2.8 Services"></a>1.2.8 Services</h4><blockquote>
<p>抽象服务出口。它就像一个基础版本的负载均衡器。</p>
</blockquote>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/2.png"></p>
<h4 id="1-2-9-Volume"><a href="#1-2-9-Volume" class="headerlink" title="1.2.9 Volume"></a>1.2.9 Volume</h4><blockquote>
<p>Pod中能够被多个容器访问的共享目录，其生命周期与Pod相同，跟容器无关。</p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> EmptyDir：Pod分配到Node时创建的，初始内容为空，Pod从Node中移除时EmptyDir数据永久删除。主要用于临时空间，Checkpoint（检查点）临时保存目录等。</li>
<li><input checked="" disabled="" type="checkbox"> hostPath：在Pod上挂载宿主机上的文件或目录，主要用于需要永久保存的。</li>
<li><input checked="" disabled="" type="checkbox"> gcePersistentDisk：使用谷歌计算引擎上永久磁盘上的文件，写入数据永久保存。</li>
<li><input checked="" disabled="" type="checkbox"> awsElasticBlockStore：使用Amazon提供的EBS Volume。</li>
<li><input checked="" disabled="" type="checkbox"> nfs：使用NFS（网络文件系统）提供的共享目录。</li>
<li><input checked="" disabled="" type="checkbox"> iSCSI：使用iSCSI设备</li>
<li><input checked="" disabled="" type="checkbox"> glusterfs：使用开源GlusterFS网络文件系统。</li>
<li><input checked="" disabled="" type="checkbox"> rbd：使用Linux块设备共享存储。</li>
<li><input checked="" disabled="" type="checkbox"> gitRepo：通过挂载一个空目录，从Git库clone一个 —&gt; git repository（仓库）给pod使用。</li>
<li><input checked="" disabled="" type="checkbox"> secret：一个secret volume用于Pod提供加密信息。</li>
<li><input checked="" disabled="" type="checkbox"> persistent Volume：“网络存储”，独立于“计算资源”而存在的实体资源，可以看作一个与kubernetes无关的网盘。</li>
</ul>
<h4 id="1-2-10-Annotation（注释）"><a href="#1-2-10-Annotation（注释）" class="headerlink" title="1.2.10 Annotation（注释）"></a>1.2.10 Annotation（注释）</h4><blockquote>
<p>与Label类似，也使用key&#x2F;value键值对的形式定义，不同于Label定义kubernetes的元数据，它时用户任意定义的附加信息，以便于外部工具进行查找。</p>
</blockquote>
<h3 id="1-3-Kubernetes总体结构"><a href="#1-3-Kubernetes总体结构" class="headerlink" title="1.3 Kubernetes总体结构"></a>1.3 Kubernetes总体结构</h3><h4 id="1-3-1-Master组件"><a href="#1-3-1-Master组件" class="headerlink" title="1.3.1 Master组件"></a>1.3.1 Master组件</h4><ul>
<li>API接口（Apiserver）：作为Kubernetes系统的入口，封装了核心对象的增删改查操作。</li>
<li>调度器（Scheduler）：插件式的调度器，负责集群的资源调度，为新建的Pod分配机器。</li>
<li>控制器管理器（Controller）：负责管理各种控制器。如：复制控制器（Replicationcontroller），端点控制器（EndPointcontroller）。</li>
</ul>
<h4 id="1-3-2-Node组件"><a href="#1-3-2-Node组件" class="headerlink" title="1.3.2 Node组件"></a>1.3.2 Node组件</h4><ul>
<li>kubelet：负责管控docker容器，如启动&#x2F;停止，监控运行状态等。</li>
<li>proxy：负责为Pod提供代理。它会定期从etcd获取所有的service，并根据service信息创建代理。</li>
</ul>
<h4 id="1-3-3-公共组件"><a href="#1-3-3-公共组件" class="headerlink" title="1.3.3 公共组件"></a>1.3.3 公共组件</h4><ul>
<li>Etcd</li>
<li>flannel</li>
</ul>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/3.png"></p>
<h3 id="1-4-Kubernetes核心原理"><a href="#1-4-Kubernetes核心原理" class="headerlink" title="1.4 Kubernetes核心原理"></a>1.4 Kubernetes核心原理</h3><h4 id="1-4-1-API-server"><a href="#1-4-1-API-server" class="headerlink" title="1.4.1 API server"></a>1.4.1 API server</h4><blockquote>
<ul>
<li>提供集群管理的API接口。<ul>
<li>api-server进程提供http（8080）&#x2F;https（6443）两个端口供访问。<blockquote>
<ul>
<li>成为集群内各个功能模块之间数据交互和通信的中心枢纽。集群内部功能模块通过API server将信息存入etcd，其他模块通过API server（用get，list或watch）读取这些信息，实现模块之间的信息交互。</li>
<li>拥有完备的集群安全机制。</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
</blockquote>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/4.png"></p>
<h4 id="1-4-2-控制器管理器（Controller-Manager）"><a href="#1-4-2-控制器管理器（Controller-Manager）" class="headerlink" title="1.4.2 控制器管理器（Controller Manager）"></a>1.4.2 控制器管理器（Controller Manager）</h4><p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/5.png"></p>
<ul>
<li>Replication controller（复制控制器）</li>
</ul>
<blockquote>
<ol>
<li>确保任何时候集群中一个rc下的pod都保持一定数量的pod副本处于正常运行状态。</li>
<li>重新调度，弹性伸缩。</li>
<li>滚动更新（Rolling Updates）</li>
</ol>
</blockquote>
<ul>
<li>Node Controller（节点控制器）</li>
</ul>
<blockquote>
<p>负责发现，管理和监控集群中的各个Node节点。</p>
</blockquote>
<ul>
<li>ResourceQuota Controller（资源控制器）</li>
</ul>
<blockquote>
<p>资源配额管理确保制定对象在任何时候都不会超量占用系统资源。<br>三个维度的配额：容器（C&#x2F;M），Pod，namespace（命名空间）（pod，rc，service，resourceQuota，Secret，PV）</p>
</blockquote>
<ul>
<li>Endpoint Controller（端点控制器）</li>
</ul>
<blockquote>
<p>定期关联service和pod（关联信息由endpoint对象维护），保证service到pod的映射总是最新的。</p>
</blockquote>
<ul>
<li>Services Controller（服务控制器）</li>
</ul>
<blockquote>
<p>监听服务（Service）的变化。</p>
</blockquote>
<h4 id="1-4-3-调度程序（Scheduler）"><a href="#1-4-3-调度程序（Scheduler）" class="headerlink" title="1.4.3 调度程序（Scheduler）"></a>1.4.3 调度程序（Scheduler）</h4><ul>
<li>负责Pod的调度</li>
<li>通过调度算法为待调度Pod列表每个Pod从Node列表选择一个最合适的Node。</li>
</ul>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/6.png"></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Kubelet</li>
</ul>
<blockquote>
<p>负责本Node节点上的Pod的创建，修改，监控，删除等。同时定时同步本Node的状态信息到API Server。</p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> kube-proxy</li>
</ul>
<blockquote>
<p>实现Service的代理及软件模式的负载均衡器。</p>
</blockquote>
<h3 id="1-5-Kubernetes的网络模型"><a href="#1-5-Kubernetes的网络模型" class="headerlink" title="1.5 Kubernetes的网络模型"></a>1.5 Kubernetes的网络模型</h3><blockquote>
<p>容器到容器通信，共享网络空间；同Node上pod通信，通过docker0网桥；不同Node上pod通信呢？？</p>
</blockquote>
<h4 id="1-5-1-隧道方案"><a href="#1-5-1-隧道方案" class="headerlink" title="1.5.1 隧道方案"></a>1.5.1 隧道方案</h4><blockquote>
<p>通过隧道，或者说覆盖网络（Overlay Networking）的方式：</p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> Weave：UDP广播，本机建立新的BR，通过PCAP互通。</li>
<li><input checked="" disabled="" type="checkbox"> Open vSwitch（OVS）：基于VxLAN和GRE协议，但是性能方面损失比较严重。</li>
<li><input checked="" disabled="" type="checkbox"> Flannel：UDP广播，VxLAN。</li>
</ul>
<blockquote>
<p>隧道方案在IaaS层的网络中应用也比较多，大家共识是随节点规模的增长，复杂度会提升，而且出了网络问题跟踪起来也比较麻烦，大规模集群情况下这是需要考虑的一个点。</p>
</blockquote>
<p><img src="/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/7.png"></p>
<blockquote>
</blockquote>
<ul>
<li>首先连上etcd，利用etcd管理可以分配的IP地址段资源，同事监控etcd中每个Pod的实际地址，并在内存中建立一个Pod节点路由表，然后下连docker0和物理网络，使用内存中的Pod节点路由表，将docker0发给它的数据包包装起来，利用物理网络连接将数据包投递到目标flanneld上。</li>
<li>Flannel之间的底层通信协议可选余地很多，有UDP、VxLan、AWS VPC等，只要能通到对端的Flannel就可以。源flanneld加包，目标flanneld解包，对于docker0是透明的。一般以UDP为主。</li>
</ul>
<h4 id="1-5-2-路由方案"><a href="#1-5-2-路由方案" class="headerlink" title="1.5.2 路由方案"></a>1.5.2 路由方案</h4><blockquote>
<p>路由方案比较典型的代表有：</p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> Calico：基于BGP协议的路由方案，支持很细致的ACL控制，对混合云亲和度比较高。</li>
<li><input checked="" disabled="" type="checkbox"> Macvlan：从逻辑和Kernel层来看隔离性和性能最优的方案，基于二层隔离，所以需要二层路由器支持，大多数云服务商不支持，所以混合云上比较难以实现。</li>
</ul>
<blockquote>
<p>路由方案一般是从3层或者2层实现隔离和跨主机容器互通的，出了问题也很容易排查。</p>
</blockquote>
<h2 id="二，快速构建Kubernetes测试集群"><a href="#二，快速构建Kubernetes测试集群" class="headerlink" title="二，快速构建Kubernetes测试集群"></a>二，快速构建Kubernetes测试集群</h2><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>ip地址</th>
</tr>
</thead>
<tbody><tr>
<td>Master</td>
<td>Ubuntu-master</td>
<td>192.168.213.129</td>
</tr>
<tr>
<td>Node</td>
<td>Ubuntu-node1</td>
<td>192.168.213.132</td>
</tr>
<tr>
<td>Node</td>
<td>Ubuntu-node2</td>
<td>192.168.213.133</td>
</tr>
</tbody></table>
<p><strong>准备工作</strong></p>
<ul>
<li>默认方式安装Ubuntu Server版本16.04</li>
<li>master节点到各个node节点ssh免密登陆</li>
<li>时间同步</li>
<li>各node节点必须关闭swap：swapoff -a，否则kubelet启动失败。</li>
<li>配置主机名及映射，每个节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有节点都要执行以下操作：</span></span><br><span class="line">root@localhost:~# vim /etc/hostname </span><br><span class="line">root@localhost:~# <span class="built_in">cat</span> /etc/hostname </span><br><span class="line">Ubuntu-master</span><br><span class="line">root@localhost:~# hostname Ubuntu-master</span><br><span class="line">root@localhost:~# bash</span><br><span class="line">root@Ubuntu-master:~# vim /etc/hosts</span><br><span class="line">root@Ubuntu-master:~# <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">127.0.1.1	localhost.localdomain	localhost</span><br><span class="line"></span><br><span class="line">192.168.213.129 Ubuntu-master       <span class="comment">#配置所有节点主机名及映射</span></span><br><span class="line">192.168.213.132 Ubuntu-node1        <span class="comment">#配置所有节点主机名及映射</span></span><br><span class="line">192.168.213.133 Ubuntu-node2        <span class="comment">#配置所有节点主机名及映射</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-系统环境设置"><a href="#2-2-系统环境设置" class="headerlink" title="2.2 系统环境设置"></a>2.2 系统环境设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看系统信息：</span></span><br><span class="line">root@Ubuntu-master:~# lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 16.04.5 LTS</span><br><span class="line">Release:	16.04</span><br><span class="line">Codename:	xenial</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用swap，并设置网关，禁用SElinux</span></span><br><span class="line">root@Ubuntu-master:~# swapoff -a        <span class="comment">#禁用swap</span></span><br><span class="line">root@Ubuntu-master:~# <span class="built_in">cat</span> /etc/rc.local         <span class="comment">#加入开机启动</span></span><br><span class="line"><span class="comment">#!/bin/sh -e</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rc.local</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="comment"># Make sure that the script will &quot;exit 0&quot; on success or any other</span></span><br><span class="line"><span class="comment"># value on error.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In order to enable or disable this script just change the execution</span></span><br><span class="line"><span class="comment"># bits.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default this script does nothing.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line">/sbin/swapoff -a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# systemctl stop firewalld          <span class="comment">#关闭firewalld防火墙</span></span><br><span class="line">Failed to stop firewalld.service: Unit firewalld.service not loaded.</span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# systemctl <span class="built_in">disable</span> firewalld       <span class="comment">#关闭firewalld防火墙开机启动</span></span><br><span class="line">Failed to execute operation: No such file or directory</span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# setenforce 0      <span class="comment">#关闭selinux，提示未安装</span></span><br><span class="line">The program <span class="string">&#x27;setenforce&#x27;</span> is currently not installed. You can install it by typing:</span><br><span class="line">apt install selinux-utils</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-3-安装新版docker-ce"><a href="#2-3-安装新版docker-ce" class="headerlink" title="2.3 安装新版docker-ce"></a>2.3 安装新版docker-ce</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# apt-get update </span><br><span class="line">root@Ubuntu-master:~# apt-get install -y apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">root@Ubuntu-master:~# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line">OK</span><br><span class="line">root@Ubuntu-master:~# add-apt-repository \</span><br><span class="line">     <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">     <span class="subst">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">     stable&quot;</span></span><br><span class="line">root@Ubuntu-master:~# apt-get update</span><br><span class="line">root@Ubuntu-master:~# apt-get -y install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment">#已经安装完毕</span></span><br><span class="line">root@Ubuntu-master:~# docker version            <span class="comment">#查看版本</span></span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.0</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.4</span><br><span class="line"> Git commit:        4d60db4</span><br><span class="line"> Built:             Wed Nov  7 00:48:57 2018</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.0</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.4</span><br><span class="line">  Git commit:       4d60db4</span><br><span class="line">  Built:            Wed Nov  7 00:16:44 2018</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>安装完docker后，设置FORWARD链规则为ACCEPT</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>


<h3 id="2-4-所有节点安装Kubeadm工具"><a href="#2-4-所有节点安装Kubeadm工具" class="headerlink" title="2.4 所有节点安装Kubeadm工具"></a>2.4 所有节点安装Kubeadm工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class="line">root@Ubuntu-Master:~# curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1326  100  1326    0     0   4237      0 --:--:-- --:--:-- --:--:--  4236</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# <span class="built_in">echo</span> <span class="string">&#x27;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">root@Ubuntu-master:~# apt-get update</span><br><span class="line">root@Ubuntu-master:~# apt-get install -y kubelet=1.11.4-00 kubeadm=1.11.4-00  kubectl=1.11.4-00</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="三，使用Kubeadm部署Kubernetes集群"><a href="#三，使用Kubeadm部署Kubernetes集群" class="headerlink" title="三，使用Kubeadm部署Kubernetes集群"></a>三，使用Kubeadm部署Kubernetes集群</h2><h3 id="3-1-使用kubeadm-init初始化master节点"><a href="#3-1-使用kubeadm-init初始化master节点" class="headerlink" title="3.1 使用kubeadm init初始化master节点"></a>3.1 使用kubeadm init初始化master节点</h3><blockquote>
<p>首先，要保证swap已经关闭。<br><code>kubeadm init -h</code>命令可以查看帮助信息。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-Master:~# kubeadm init -h</span><br><span class="line"><span class="comment">#可以查看init可用的参数，这里使用这两个参数：</span></span><br><span class="line">    --pod-network-cidr            <span class="comment">#自定义pod网络</span></span><br><span class="line">    --ignore-preflight-errors     <span class="comment">#忽略一些错误</span></span><br><span class="line">    --apiserver-advertise-address <span class="comment">#指定APIserver的ip地址</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-开始初始化集群"><a href="#3-1-1-开始初始化集群" class="headerlink" title="3.1.1 开始初始化集群"></a>3.1.1 开始初始化集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubeadm init --pod-network-cidr 10.244.0.0/16 --ignore-preflight-errors all --apiserver-advertise-address 192.168.213.129 --kubernetes-version=v1.11.4</span><br><span class="line">[init] using Kubernetes version: v1.11.4</span><br><span class="line">[preflight] running pre-flight checks</span><br><span class="line">I1127 19:11:31.452452   20717 kernel_validator.go:81] Validating kernel version</span><br><span class="line">I1127 19:11:31.452675   20717 kernel_validator.go:96] Validating kernel config</span><br><span class="line">[preflight] The system verification failed. Printing the output from the verification:</span><br><span class="line">KERNEL_VERSION: 4.4.0-131-generic</span><br><span class="line">CONFIG_NAMESPACES: enabled</span><br><span class="line">CONFIG_NET_NS: enabled</span><br><span class="line">CONFIG_PID_NS: enabled</span><br><span class="line">CONFIG_IPC_NS: enabled</span><br><span class="line">CONFIG_UTS_NS: enabled</span><br><span class="line">CONFIG_CGROUPS: enabled</span><br><span class="line">CONFIG_CGROUP_CPUACCT: enabled</span><br><span class="line">CONFIG_CGROUP_DEVICE: enabled</span><br><span class="line">CONFIG_CGROUP_FREEZER: enabled</span><br><span class="line">CONFIG_CGROUP_SCHED: enabled</span><br><span class="line">CONFIG_CPUSETS: enabled</span><br><span class="line">CONFIG_MEMCG: enabled</span><br><span class="line">CONFIG_INET: enabled</span><br><span class="line">CONFIG_EXT4_FS: enabled</span><br><span class="line">CONFIG_PROC_FS: enabled</span><br><span class="line">CONFIG_NETFILTER_XT_TARGET_REDIRECT: enabled (as module)</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)</span><br><span class="line">CONFIG_OVERLAY_FS: enabled (as module)</span><br><span class="line">CONFIG_AUFS_FS: enabled (as module)</span><br><span class="line">CONFIG_BLK_DEV_DM: enabled</span><br><span class="line">DOCKER_VERSION: 18.09.0</span><br><span class="line">OS: Linux</span><br><span class="line">CGROUPS_CPU: enabled</span><br><span class="line">CGROUPS_CPUACCT: enabled</span><br><span class="line">CGROUPS_CPUSET: enabled</span><br><span class="line">CGROUPS_DEVICES: enabled</span><br><span class="line">CGROUPS_FREEZER: enabled</span><br><span class="line">CGROUPS_MEMORY: enabled</span><br><span class="line">	[WARNING SystemVerification]: unsupported docker version: 18.09.0</span><br><span class="line">[preflight/images] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight/images] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight/images] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">[kubelet] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[preflight] Activating the kubelet service</span><br><span class="line">[certificates] Generated ca certificate and key.</span><br><span class="line">[certificates] Generated apiserver certificate and key.</span><br><span class="line">[certificates] apiserver serving cert is signed <span class="keyword">for</span> DNS names [ubuntu-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.213.129]</span><br><span class="line">[certificates] Generated apiserver-kubelet-client certificate and key.</span><br><span class="line">[certificates] Generated sa key and public key.</span><br><span class="line">[certificates] Generated front-proxy-ca certificate and key.</span><br><span class="line">[certificates] Generated front-proxy-client certificate and key.</span><br><span class="line">[certificates] Generated etcd/ca certificate and key.</span><br><span class="line">[certificates] Generated etcd/server certificate and key.</span><br><span class="line">[certificates] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [ubuntu-master localhost] and IPs [127.0.0.1 ::1]</span><br><span class="line">[certificates] Generated etcd/peer certificate and key.</span><br><span class="line">[certificates] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [ubuntu-master localhost] and IPs [192.168.213.129 127.0.0.1 ::1]</span><br><span class="line">[certificates] Generated etcd/healthcheck-client certificate and key.</span><br><span class="line">[certificates] Generated apiserver-etcd-client certificate and key.</span><br><span class="line">[certificates] valid certificates and keys now exist <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">&quot;/etc/kubernetes/admin.conf&quot;</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">&quot;/etc/kubernetes/controller-manager.conf&quot;</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">&quot;/etc/kubernetes/scheduler.conf&quot;</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-apiserver to <span class="string">&quot;/etc/kubernetes/manifests/kube-apiserver.yaml&quot;</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-controller-manager to <span class="string">&quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot;</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-scheduler to <span class="string">&quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot;</span></span><br><span class="line">[etcd] Wrote Static Pod manifest <span class="keyword">for</span> a <span class="built_in">local</span> etcd instance to <span class="string">&quot;/etc/kubernetes/manifests/etcd.yaml&quot;</span></span><br><span class="line">[init] waiting <span class="keyword">for</span> the kubelet to boot up the control plane as Static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span> </span><br><span class="line">[init] this might take a minute or longer <span class="keyword">if</span> the control plane images have to be pulled</span><br><span class="line">[apiclient] All control plane components are healthy after 55.521316 seconds</span><br><span class="line">[uploadconfig] storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config-1.11&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[markmaster] Marking the node ubuntu-master as master by adding the label <span class="string">&quot;node-role.kubernetes.io/master=&#x27;&#x27;&quot;</span></span><br><span class="line">[markmaster] Marking the node ubuntu-master as master by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[patchnode] Uploading the CRI Socket information <span class="string">&quot;/var/run/dockershim.sock&quot;</span> to the Node API object <span class="string">&quot;ubuntu-master&quot;</span> as an annotation</span><br><span class="line">[bootstraptoken] using token: h1gxcw.v3us091vr7ui7j3u</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstraptoken] creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> 192.168.213.129:6443 --token h1gxcw.v3us091vr7ui7j3u --discovery-token-ca-cert-hash sha256:b5515901146e3364e65406b595e055ef54a67c1e470c0eef14c070400a475448</span><br><span class="line"></span><br><span class="line"><span class="comment">#把上面kubeadm join这一句话记录下来，在node端加入时需要用到。否则以后找起来会很麻烦！！！</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>问题描述:</strong><br>使用Kubernetes V1.11.4版本部署集群业务，在进行kubeadm init时，需要从k8s.grc.io仓库拉取镜像：</p>
</blockquote>
<p><strong>重点：以下所有镜像，node节点也要安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[preflight/images] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/kube-apiserver-amd64:v1.11.4]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/kube-controller-manager-amd64:v1.11.4]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/kube-scheduler-amd64:v1.11.4]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/kube-proxy-amd64:v1.11.4]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/pause:3.1]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/etcd-amd64:3.2.18]: <span class="built_in">exit</span> status 1</span><br><span class="line">	[WARNING ImagePull]: failed to pull image [k8s.gcr.io/coredns:1.1.3]: <span class="built_in">exit</span> status 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>解决办法：</strong><br>docker.io仓库对google的容器做了镜像，可以通过下列命令下拉取相关镜像：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/kube-apiserver-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/kube-controller-manager-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/kube-scheduler-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/kube-proxy-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/pause:3.1</span><br><span class="line">root@Ubuntu-Master:~# docker pull mirrorgooglecontainers/etcd-amd64:3.2.18</span><br><span class="line">root@Ubuntu-Master:~# docker pull coredns/coredns:1.1.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>版本信息需要根据实际情况进行相应的修改。通过docker tag命令来修改镜像的标签：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/kube-apiserver-amd64:v1.11.4 k8s.gcr.io/kube-apiserver-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/kube-controller-manager-amd64:v1.11.4 k8s.gcr.io/kube-controller-manager-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/kube-scheduler-amd64:v1.11.4 k8s.gcr.io/kube-scheduler-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/kube-proxy-amd64:v1.11.4 k8s.gcr.io/kube-proxy-amd64:v1.11.4</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/mirrorgooglecontainers/etcd-amd64:3.2.18 k8s.gcr.io/etcd-amd64:3.2.18</span><br><span class="line">root@Ubuntu-Master:~# docker tag docker.io/coredns/coredns:1.1.3 k8s.gcr.io/coredns:1.1.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用docker rmi删除不用镜像，通过docker images命令显示，已经有我们需要的镜像文件，可以继续部署工作了：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-Master:~# docker images</span><br><span class="line">REPOSITORY                                 TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k8s.gcr.io/kube-proxy-amd64                v1.11.4             5071d096cfcd        4 weeks ago         98.2MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager-amd64   v1.11.4             dc1d57df5ac0        4 weeks ago         155MB</span><br><span class="line">k8s.gcr.io/kube-apiserver-amd64            v1.11.4             de6de495c1f4        4 weeks ago         187MB</span><br><span class="line">k8s.gcr.io/kube-scheduler-amd64            v1.11.4             569cb58b9c03        4 weeks ago         56.8MB</span><br><span class="line">k8s.gcr.io/coredns                         1.1.3               b3b94275d97c        6 months ago        45.6MB</span><br><span class="line">k8s.gcr.io/etcd-amd64                      3.2.18              b8df3b177be2        7 months ago        219MB</span><br><span class="line">k8s.gcr.io/pause                           3.1                 da86e6ba6ca1        11 months ago       742kB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-根据提示，执行如下命令来配置kubectl"><a href="#3-1-2-根据提示，执行如下命令来配置kubectl" class="headerlink" title="3.1.2 根据提示，执行如下命令来配置kubectl"></a>3.1.2 根据提示，执行如下命令来配置kubectl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-Master:~# <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">root@Ubuntu-Master:~# <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">root@Ubuntu-Master:~# <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此！Master节点配置完毕，并且可以使用kubectl来进行各种操作了。</p>
</blockquote>
<h3 id="3-2-Node节点加入集群"><a href="#3-2-Node节点加入集群" class="headerlink" title="3.2 Node节点加入集群"></a>3.2 Node节点加入集群</h3><blockquote>
<p>在所有Node节点使用kubeadm join加入集群：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确保swap缓存已关闭</span></span><br><span class="line"><span class="comment">#复制在master节点上记录下的那句话，以加入集群：</span></span><br><span class="line">root@Ubuntu-node1:~# kubeadm <span class="built_in">join</span> 192.168.213.129:6443 --token h1gxcw.v3us091vr7ui7j3u --discovery-token-ca-cert-hash sha256:b5515901146e3364e65406b595e055ef54a67c1e470c0eef14c070400a475448 --ignore-preflight-errors all</span><br><span class="line"><span class="comment">#--ignore-preflight-errors all          加入这个参数的原因是因为我的docker版本太高</span></span><br><span class="line">[preflight] running pre-flight checks</span><br><span class="line">	[WARNING RequiredIPVSKernelModulesAvailable]: the IPVS proxier will not be used, because the following required kernel modules are not loaded: [ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh] or no <span class="built_in">builtin</span> kernel ipvs support: map[ip_vs_wrr:&#123;&#125; ip_vs_sh:&#123;&#125; nf_conntrack_ipv4:&#123;&#125; ip_vs:&#123;&#125; ip_vs_rr:&#123;&#125;]</span><br><span class="line">you can solve this problem with following methods:</span><br><span class="line"> 1. Run <span class="string">&#x27;modprobe -- &#x27;</span> to load missing kernel modules;</span><br><span class="line">2. Provide the missing <span class="built_in">builtin</span> kernel ipvs support</span><br><span class="line"></span><br><span class="line">I1127 19:22:30.298339   20277 kernel_validator.go:81] Validating kernel version</span><br><span class="line">I1127 19:22:30.298763   20277 kernel_validator.go:96] Validating kernel config</span><br><span class="line">[preflight] The system verification failed. Printing the output from the verification:</span><br><span class="line">KERNEL_VERSION: 4.4.0-131-generic</span><br><span class="line">CONFIG_NAMESPACES: enabled</span><br><span class="line">CONFIG_NET_NS: enabled</span><br><span class="line">CONFIG_PID_NS: enabled</span><br><span class="line">CONFIG_IPC_NS: enabled</span><br><span class="line">CONFIG_UTS_NS: enabled</span><br><span class="line">CONFIG_CGROUPS: enabled</span><br><span class="line">CONFIG_CGROUP_CPUACCT: enabled</span><br><span class="line">CONFIG_CGROUP_DEVICE: enabled</span><br><span class="line">CONFIG_CGROUP_FREEZER: enabled</span><br><span class="line">CONFIG_CGROUP_SCHED: enabled</span><br><span class="line">CONFIG_CPUSETS: enabled</span><br><span class="line">CONFIG_MEMCG: enabled</span><br><span class="line">CONFIG_INET: enabled</span><br><span class="line">CONFIG_EXT4_FS: enabled</span><br><span class="line">CONFIG_PROC_FS: enabled</span><br><span class="line">CONFIG_NETFILTER_XT_TARGET_REDIRECT: enabled (as module)</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)</span><br><span class="line">CONFIG_OVERLAY_FS: enabled (as module)</span><br><span class="line">CONFIG_AUFS_FS: enabled (as module)</span><br><span class="line">CONFIG_BLK_DEV_DM: enabled</span><br><span class="line">DOCKER_VERSION: 18.09.0</span><br><span class="line">OS: Linux</span><br><span class="line">CGROUPS_CPU: enabled</span><br><span class="line">CGROUPS_CPUACCT: enabled</span><br><span class="line">CGROUPS_CPUSET: enabled</span><br><span class="line">CGROUPS_DEVICES: enabled</span><br><span class="line">CGROUPS_FREEZER: enabled</span><br><span class="line">CGROUPS_MEMORY: enabled</span><br><span class="line">	[WARNING SystemVerification]: unsupported docker version: 18.09.0</span><br><span class="line">[discovery] Trying to connect to API Server <span class="string">&quot;192.168.213.129:6443&quot;</span></span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from <span class="string">&quot;https://192.168.213.129:6443&quot;</span></span><br><span class="line">[discovery] Requesting info from <span class="string">&quot;https://192.168.213.129:6443&quot;</span> again to validate TLS against the pinned public key</span><br><span class="line">[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server <span class="string">&quot;192.168.213.129:6443&quot;</span></span><br><span class="line">[discovery] Successfully established connection with API Server <span class="string">&quot;192.168.213.129:6443&quot;</span></span><br><span class="line">[kubelet] Downloading configuration <span class="keyword">for</span> the kubelet from the <span class="string">&quot;kubelet-config-1.11&quot;</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">[kubelet] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[preflight] Activating the kubelet service</span><br><span class="line">[tlsbootstrap] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class="line">[patchnode] Uploading the CRI Socket information <span class="string">&quot;/var/run/dockershim.sock&quot;</span> to the Node API object <span class="string">&quot;ubuntu-node1&quot;</span> as an annotation</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to master and a response</span><br><span class="line">  was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the master to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-3-在Master端查看节点信息"><a href="#3-3-在Master端查看节点信息" class="headerlink" title="3.3 在Master端查看节点信息"></a>3.3 在Master端查看节点信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl get node</span><br><span class="line">NAME            STATUS     ROLES     AGE       VERSION</span><br><span class="line">ubuntu-master   NotReady   master    18m       v1.11.4</span><br><span class="line">ubuntu-node1    NotReady   &lt;none&gt;    8m        v1.11.4</span><br><span class="line">ubuntu-node2    NotReady   &lt;none&gt;    6m        v1.11.4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>显示系统pod信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl get pod -n kube-system -o wide</span><br><span class="line">NAME                                       READY     STATUS              RESTARTS   AGE       IP                NODE            NOMINATED NODE</span><br><span class="line">calico-etcd-97mx4                          1/1       Running             0          17m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-kube-controllers-55dbfb6865-6phcj   1/1       Running             0          17m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-node-c9j4h                          0/2       ContainerCreating   0          17m       192.168.213.133   ubuntu-node2    &lt;none&gt;</span><br><span class="line">calico-node-gtm59                          2/2       Running             0          17m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-node-lmlwn                          0/2       ContainerCreating   0          17m       192.168.213.132   ubuntu-node1    &lt;none&gt;</span><br><span class="line">coredns-78fcdf6894-c8mjx                   1/1       Running             1          33m       192.168.172.193   ubuntu-master   &lt;none&gt;</span><br><span class="line">coredns-78fcdf6894-vmn8w                   1/1       Running             1          33m       192.168.172.194   ubuntu-master   &lt;none&gt;</span><br><span class="line">etcd-ubuntu-master                         1/1       Running             0          23m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-apiserver-ubuntu-master               1/1       Running             0          23m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-controller-manager-ubuntu-master      1/1       Running             0          23m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-proxy-5dpg8                           0/1       ContainerCreating   0          23m       192.168.213.132   ubuntu-node1    &lt;none&gt;</span><br><span class="line">kube-proxy-nr9dp                           0/1       ContainerCreating   0          22m       192.168.213.133   ubuntu-node2    &lt;none&gt;</span><br><span class="line">kube-proxy-wp9jf                           1/1       Running             0          33m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-scheduler-ubuntu-master               1/1       Running             0          23m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>命令说明：</strong><br><code>kubectl get pod &lt;pod-name&gt; -o yaml</code>  以yaml格式显示Pod的详细信息</p>
</blockquote>
<h3 id="3-4-master节点安装CNI网络插件"><a href="#3-4-master节点安装CNI网络插件" class="headerlink" title="3.4 master节点安装CNI网络插件"></a>3.4 master节点安装CNI网络插件</h3><blockquote>
<ul>
<li>各Node节点处于”NotReady”状态，需要安装一个网络插件</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubeadm/1.7/calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">daemonset.extensions/calico-etcd created</span><br><span class="line">service/calico-etcd created</span><br><span class="line">daemonset.extensions/calico-node created</span><br><span class="line">deployment.extensions/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-cni-plugin created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-cni-plugin created</span><br><span class="line">serviceaccount/calico-cni-plugin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>几分钟后，再次在master端查看节点信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl get node</span><br><span class="line">NAME            STATUS    ROLES     AGE       VERSION</span><br><span class="line">ubuntu-master   Ready     master    44m       v1.11.4</span><br><span class="line">ubuntu-node1    Ready     &lt;none&gt;    34m       v1.11.4</span><br><span class="line">ubuntu-node2    Ready     &lt;none&gt;    33m       v1.11.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#至此！所有组件全部运行</span></span><br><span class="line">root@Ubuntu-master:~# kubectl get pod -n kube-system -o wide</span><br><span class="line">NAME                                       READY     STATUS    RESTARTS   AGE       IP                NODE            NOMINATED NODE</span><br><span class="line">calico-etcd-97mx4                          1/1       Running   0          27m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-kube-controllers-55dbfb6865-6phcj   1/1       Running   0          27m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-node-c9j4h                          2/2       Running   0          27m       192.168.213.133   ubuntu-node2    &lt;none&gt;</span><br><span class="line">calico-node-gtm59                          2/2       Running   0          27m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">calico-node-lmlwn                          2/2       Running   0          27m       192.168.213.132   ubuntu-node1    &lt;none&gt;</span><br><span class="line">coredns-78fcdf6894-c8mjx                   1/1       Running   1          44m       192.168.172.193   ubuntu-master   &lt;none&gt;</span><br><span class="line">coredns-78fcdf6894-vmn8w                   1/1       Running   1          44m       192.168.172.194   ubuntu-master   &lt;none&gt;</span><br><span class="line">etcd-ubuntu-master                         1/1       Running   0          34m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-apiserver-ubuntu-master               1/1       Running   0          34m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-controller-manager-ubuntu-master      1/1       Running   0          34m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-proxy-5dpg8                           1/1       Running   0          34m       192.168.213.132   ubuntu-node1    &lt;none&gt;</span><br><span class="line">kube-proxy-nr9dp                           1/1       Running   0          33m       192.168.213.133   ubuntu-node2    &lt;none&gt;</span><br><span class="line">kube-proxy-wp9jf                           1/1       Running   0          44m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line">kube-scheduler-ubuntu-master               1/1       Running   0          34m       192.168.213.129   ubuntu-master   &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="四，测试集群"><a href="#四，测试集群" class="headerlink" title="四，测试集群"></a>四，测试集群</h2><p><strong>（1）配置kubectl的命令补全功能</strong></p>
<blockquote>
<p>命令补全功能由安装包“bash-completion”提供，Ubuntu系统中默认已安装。<strong>（所有节点都要配置）</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前shell生效：</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"><span class="comment">#永久生效：</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<p><strong>（2）启动一个pod验证集群是否正常运行</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl run -h        <span class="comment">#查看命令使用方法</span></span><br><span class="line">...此处省略若干内容...</span><br><span class="line">Usage:</span><br><span class="line">  kubectl run NAME --image=image [--<span class="built_in">env</span>=<span class="string">&quot;key=value&quot;</span>] [--port=port] [--replicas=replicas] [--dry-run=bool]</span><br><span class="line">[--overrides=inline-json] [--<span class="built_in">command</span>] -- [COMMAND] [args...] [options]</span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;kubectl options&quot;</span> <span class="keyword">for</span> a list of global command-line options (applies to all commands).</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>启动一个nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl run nginx --image=nginx:1.10 --port=80        <span class="comment">#启动一个nginx容器</span></span><br><span class="line">deployment.apps/nginx created           <span class="comment">#启动成功</span></span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# kubectl get pod -o wide       <span class="comment">#查看pod，已经是运行状态。（等一会在查看，启动也需要时间）</span></span><br><span class="line">NAME                    READY     STATUS    RESTARTS   AGE       IP               NODE           NOMINATED NODE</span><br><span class="line">nginx-d78c44b45-nshjd   1/1       Running   0          1m        192.168.23.129   ubuntu-node2   &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试：访问nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# curl -I 192.168.23.129</span><br><span class="line">HTTP/1.1 200 OK                 <span class="comment">#访问成功</span></span><br><span class="line">Server: nginx/1.10.3</span><br><span class="line">Date: Tue, 27 Nov 2018 12:39:25 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 31 Jan 2017 15:01:11 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5890a6b7-264&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>（3）把nginx暴露一个端口出来，使集群之外也可以访问</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl expose -h         <span class="comment">#查看命令使用方法</span></span><br><span class="line">...此处省略若干内容...</span><br><span class="line">Usage:</span><br><span class="line">  kubectl expose (-f FILENAME | TYPE NAME) [--port=port] [--protocol=TCP|UDP] [--target-port=number-or-name]</span><br><span class="line">[--name=name] [--external-ip=external-ip-of-service] [--<span class="built_in">type</span>=<span class="built_in">type</span>] [options]</span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;kubectl options&quot;</span> <span class="keyword">for</span> a list of global command-line options (applies to all commands).</span><br><span class="line"></span><br><span class="line">root@Ubuntu-master:~# kubectl expose deployment nginx --port=801 --target-port=80 --<span class="built_in">type</span>=NodePort --name nginx-svc</span><br><span class="line">service/nginx-svc exposed           <span class="comment">#端口暴露成功</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-master:~# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         1h</span><br><span class="line">nginx-svc    NodePort    10.99.101.191   &lt;none&gt;        801:30418/TCP   1m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>（4）现在可以访问任意Node的30418端口访问到nginx服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@Ubuntu-node1:~# curl 192.168.213.132:30418         <span class="comment">#成功</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果发现那个Node端口无法访问，则设置默认FORWARD链规则为ACCEPT<br><code>iptables -P FORWARD ACCEPT</code></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io">Kkabuzs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/">https://kkabuzs.github.io/articles/2018/11/22/ubuntu1604kuaisugoujiank8sceshijiqun/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://kkabuzs.github.io" target="_blank">kkabuzs博客屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post-share"><div class="social-share" data-image="/themes-img/touxiang.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/articles/2018/11/21/kuberneteszhivolumeguazai/" title="Kubernetes之Volume挂载"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Kubernetes之Volume挂载</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Kubernetes之Volume挂载一，Volume Container中的磁盘文件是短暂的，这在容器中运行时会给非平凡的应用程序带来一些问题。首先，当容器崩溃时，kubelet将重新启动它，但文件将丢失，Container以干净状态启动。其次，当在一起运行Container时，Pod通常需要在这些容器之间共享文件。Kubernetes Volume抽象解决了这两个问题。  1.1...</div></div></div></a><a class="pagination-related" href="/articles/2018/11/29/ubuntu1604ansibleyijianbushugaokeyongk8sjiqun/" title="Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群一，安装ansible1.1 将存放ansible的PPA（个人存包档）项目添加到系统中12345678910111213141516vagrant@shannonai:~$ sudo apt-add-repository ppa:ansible/ansible Ansible is a radically simple IT automation platform that makes your applications and systems easier to deploy. Avoid writingscripts or custom code to deploy and update your applications— automate in a language that approaches plain English,...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/articles/2018/12/28/kubernetesyamlbushujixiefadingyi/" title="kubernetes yaml部署及各种yaml写法和含义"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-12-28</div><div class="info-item-2">kubernetes yaml部署及各种yaml写法和含义</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  kubernetes yaml部署及各种yaml写法和含义一，环境介绍   主机名 IP地址 CPU 内存 描述    k8s-master01 192.168.101.61 2核 4GB k8s master   k8s-node01 192.168.101.62 2核 4GB k8s node节点   k8s-node02 192.168.101.125 2核 4GB k8s node节点   二，RC的写法及SVC(service)的写法及用法2.1 创建一个mysql的RC123456789101112131415161718192021222324252627[root@k8s-master01 kubernetes-yaml]# pwd/root/kubernetes-yaml[root@k8s-master01 kubernetes-yaml]# vim msyql-rc.yamlapiVersion:...</div></div></div></a><a class="pagination-related" href="/articles/2018/11/21/kuberneteszhivolumeguazai/" title="Kubernetes之Volume挂载"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-21</div><div class="info-item-2">Kubernetes之Volume挂载</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Kubernetes之Volume挂载一，Volume Container中的磁盘文件是短暂的，这在容器中运行时会给非平凡的应用程序带来一些问题。首先，当容器崩溃时，kubelet将重新启动它，但文件将丢失，Container以干净状态启动。其次，当在一起运行Container时，Pod通常需要在这些容器之间共享文件。Kubernetes Volume抽象解决了这两个问题。  1.1...</div></div></div></a><a class="pagination-related" href="/articles/2018/11/29/ubuntu1604ansibleyijianbushugaokeyongk8sjiqun/" title="Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-29</div><div class="info-item-2">Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Ubuntu-16.04安装ansible+用ansible一键部署k8s高可用测试集群一，安装ansible1.1 将存放ansible的PPA（个人存包档）项目添加到系统中12345678910111213141516vagrant@shannonai:~$ sudo apt-add-repository ppa:ansible/ansible Ansible is a radically simple IT automation platform that makes your applications and systems easier to deploy. Avoid writingscripts or custom code to deploy and update your applications— automate in a language that approaches plain English,...</div></div></div></a><a class="pagination-related" href="/articles/2019/04/09/centos7erjinzhibushukubernetes1-13jiqun/" title="CentOS 7 使用二进制部署 Kubernetes 1.13集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-04-09</div><div class="info-item-2">CentOS 7 使用二进制部署 Kubernetes 1.13集群</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  CentOS 7 使用二进制部署 Kubernetes 1.13集群一，概述 Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes提供了应用部署，规划，更新，维护的一种机制。  1.1...</div></div></div></a><a class="pagination-related" href="/articles/2019/07/01/centos7shiyongkubeadmbushukubernetes1-14-1jiqun/" title="CentOS 7 使用kubeadm部署kubernetes 1.14.1集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-01</div><div class="info-item-2">CentOS 7 使用kubeadm部署kubernetes 1.14.1集群</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  CentOS 7 使用kubeadm部署kubernetes 1.14.1集群一，主机清单   主机名 ip 描述 版本    gago-k8s-master 192.168.8.77 master节点 v1.14.1   gago-k8s-node1 192.168.8.174 node节点 v1.14.1   gago-k8s-node2 192.168.8.227 node节点 v1.14.1   gago-k8s-node3 192.168.8.84 node节点 v1.14.1   二，版本信息1234567# Linux发行版信息[root@gago-k8s-master ~]# cat /etc/redhat-release CentOS Linux release 7.2.1511 (Core) # Linux内核[root@gago-k8s-master ~]# uname...</div></div></div></a><a class="pagination-related" href="/articles/2019/06/18/jiejue-kubernetes-buneng-harbor-pull-images/" title="解决kubernetes不能从harbor pull image"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-06-18</div><div class="info-item-2">解决kubernetes不能从harbor pull image</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。   在实现kubernetes ci的时候发现node节点不能从harbor的私有仓库将image直接pull下来。但是直接从node节点直接pull的话又是没有问题的，后来发现如果想要kubernetes直接pull的话需要一个secret。  一，以下面的为例介绍 下面的是创建service以及deployment的例子  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748apiVersion: v1kind: Namespacemetadata:  name: test---apiVersion: v1kind: Servicemetadata:  name: webapp  namespace: test  labels:    app: nginxspec:  ports:  - port: 80  ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Kkabuzs</div><div class="author-info-description">学习记录和整理</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">三人行，必有我师！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ubuntu16-04%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BAkubernetes%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">Ubuntu16.04快速构建kubernetes测试集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%EF%BC%8Ckubernetes%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6%E5%92%8C%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">一，kubernetes的基本框架和基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-k8s%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8k8s%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 k8s是什么？为什么使用k8s？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-kubernetes%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 kubernetes概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-Master"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1.2.1 Master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-Node"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">1.2.2 Node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-Pods"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">1.2.3 Pods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-Labels%EF%BC%88%E6%A0%87%E7%AD%BE%EF%BC%89"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">1.2.4 Labels（标签）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-Replication-controllers%EF%BC%88%E5%A4%8D%E5%88%B6%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">1.2.5 Replication controllers（复制控制器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-6-Deployment%EF%BC%88%E9%83%A8%E7%BD%B2%EF%BC%89"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">1.2.6 Deployment（部署）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-7-Horizontal-Pod-Autocaler%EF%BC%88HPA%EF%BC%89"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">1.2.7 Horizontal Pod Autocaler（HPA）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-8-Services"><span class="toc-number">1.1.2.8.</span> <span class="toc-text">1.2.8 Services</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-9-Volume"><span class="toc-number">1.1.2.9.</span> <span class="toc-text">1.2.9 Volume</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-10-Annotation%EF%BC%88%E6%B3%A8%E9%87%8A%EF%BC%89"><span class="toc-number">1.1.2.10.</span> <span class="toc-text">1.2.10 Annotation（注释）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Kubernetes%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Kubernetes总体结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-Master%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1 Master组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-Node%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">1.3.2 Node组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">1.3.3 公共组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Kubernetes%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 Kubernetes核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-API-server"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">1.4.1 API server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-%E6%8E%A7%E5%88%B6%E5%99%A8%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88Controller-Manager%EF%BC%89"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">1.4.2 控制器管理器（Controller Manager）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-%E8%B0%83%E5%BA%A6%E7%A8%8B%E5%BA%8F%EF%BC%88Scheduler%EF%BC%89"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">1.4.3 调度程序（Scheduler）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Kubernetes%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 Kubernetes的网络模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-%E9%9A%A7%E9%81%93%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">1.5.1 隧道方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-%E8%B7%AF%E7%94%B1%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">1.5.2 路由方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8C%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BAKubernetes%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.</span> <span class="toc-text">二，快速构建Kubernetes测试集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 系统环境设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AE%89%E8%A3%85%E6%96%B0%E7%89%88docker-ce"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 安装新版docker-ce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85Kubeadm%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 所有节点安装Kubeadm工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%EF%BC%8C%E4%BD%BF%E7%94%A8Kubeadm%E9%83%A8%E7%BD%B2Kubernetes%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.</span> <span class="toc-text">三，使用Kubeadm部署Kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BD%BF%E7%94%A8kubeadm-init%E5%88%9D%E5%A7%8B%E5%8C%96master%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 使用kubeadm init初始化master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%BC%80%E5%A7%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">3.1.1 开始初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E6%A0%B9%E6%8D%AE%E6%8F%90%E7%A4%BA%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%A6%82%E4%B8%8B%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%85%8D%E7%BD%AEkubectl"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">3.1.2 根据提示，执行如下命令来配置kubectl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Node%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 Node节点加入集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9C%A8Master%E7%AB%AF%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 在Master端查看节点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-master%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85CNI%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 master节点安装CNI网络插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8C%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">四，测试集群</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fenpianjiqun/" title="MongoDB-6.0.21离线分片集群部署">MongoDB-6.0.21离线分片集群部署</a><time datetime="2025-04-21T17:53:44.000Z" title="发表于 2025-04-22 01:53:44">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fubenjibushu/" title="MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式">MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式</a><time datetime="2025-04-21T17:51:21.000Z" title="发表于 2025-04-22 01:51:21">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/21/mongodb-6-0-21-lixian-danjiedianbushu/" title="MongoDB-6.0.21离线单节点部署">MongoDB-6.0.21离线单节点部署</a><time datetime="2025-04-21T15:55:06.000Z" title="发表于 2025-04-21 23:55:06">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/15/piliangshanchuk8szhongyibeiquzhudepod/" title="批量删除k8s中已经被驱逐（Evicted）的pod">批量删除k8s中已经被驱逐（Evicted）的pod</a><time datetime="2023-05-15T01:19:40.000Z" title="发表于 2023-05-15 09:19:40">2023-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/10/jichengyupaisheng/" title="继承与派生">继承与派生</a><time datetime="2023-05-10T05:52:52.000Z" title="发表于 2023-05-10 13:52:52">2023-05-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Kkabuzs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>