<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Keepalived高可用集群 | kkabuzs博客屋</title><meta name="author" content="Kkabuzs"><meta name="copyright" content="Kkabuzs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Keepalived高可用集群一，Keepalived高可用软件1.1 Keepalived介绍   Keepalived软件起初是专门为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP">
<meta property="og:type" content="article">
<meta property="og:title" content="Keepalived高可用集群">
<meta property="og:url" content="https://kkabuzs.github.io/articles/2018/08/31/keepalivedgaokeyongjiqun/index.html">
<meta property="og:site_name" content="kkabuzs博客屋">
<meta property="og:description" content="无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Keepalived高可用集群一，Keepalived高可用软件1.1 Keepalived介绍   Keepalived软件起初是专门为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg">
<meta property="article:published_time" content="2018-08-31T07:45:40.000Z">
<meta property="article:modified_time" content="2025-08-28T08:45:11.499Z">
<meta property="article:author" content="Kkabuzs">
<meta property="article:tag" content="Keepalived">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kkabuzs.github.io/themes-img/touxiang.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Keepalived高可用集群",
  "url": "https://kkabuzs.github.io/articles/2018/08/31/keepalivedgaokeyongjiqun/",
  "image": "https://kkabuzs.github.io/themes-img/touxiang.jpg",
  "datePublished": "2018-08-31T07:45:40.000Z",
  "dateModified": "2025-08-28T08:45:11.499Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kkabuzs",
      "url": "https://kkabuzs.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/themes-img/touxiang.jpg"><link rel="canonical" href="https://kkabuzs.github.io/articles/2018/08/31/keepalivedgaokeyongjiqun/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Keepalived高可用集群',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/themes-img/yinhe.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/themes-img/touxiang.jpg" alt="Logo"><span class="site-name">kkabuzs博客屋</span></a><a class="nav-page-title" href="/"><span class="site-name">Keepalived高可用集群</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Keepalived高可用集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-08-31T07:45:40.000Z" title="发表于 2018-08-31 15:45:40">2018-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-28T08:45:11.499Z" title="更新于 2025-08-28 16:45:11">2025-08-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/">架构基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><em>无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。</em><br><em>坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。</em></p>
</blockquote>
<h1 id="Keepalived高可用集群"><a href="#Keepalived高可用集群" class="headerlink" title="Keepalived高可用集群"></a>Keepalived高可用集群</h1><h2 id="一，Keepalived高可用软件"><a href="#一，Keepalived高可用软件" class="headerlink" title="一，Keepalived高可用软件"></a>一，Keepalived高可用软件</h2><h3 id="1-1-Keepalived介绍"><a href="#1-1-Keepalived介绍" class="headerlink" title="1.1 Keepalived介绍"></a>1.1 Keepalived介绍</h3><blockquote>
</blockquote>
<ul>
<li>Keepalived软件起初是专门为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP功能。因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx，Haproxy，MySQL等）的高可用解决方案软件。</li>
<li>Keepalived软件主要是通过VRRP协议实现高可用功能的。VRRP是Virtual Router Redundancy Protocol（虚拟路由器冗余协议）的缩写，VRRP出现的目的就是为了解决静态路由单点故障问题的，他能够保证当个别节点宕机时，整个网络可以不间断地运行。所以，Keepalived一方面具有配置管理LVS的功能，同时还具有对LVS下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能。</li>
</ul>
<h3 id="1-2-Keepalived服务的三个重要功能"><a href="#1-2-Keepalived服务的三个重要功能" class="headerlink" title="1.2 Keepalived服务的三个重要功能"></a>1.2 Keepalived服务的三个重要功能</h3><p>（1）管理LVS负载均衡软件</p>
<p>（2）实现对LVS集群节点健康检查功能（healthcheck）</p>
<p>（3）作为系统网络服务的高可用功能（failover）</p>
<h3 id="1-3-Keepalived高可用故障切换转移原理"><a href="#1-3-Keepalived高可用故障切换转移原理" class="headerlink" title="1.3 Keepalived高可用故障切换转移原理"></a>1.3 Keepalived高可用故障切换转移原理</h3><blockquote>
</blockquote>
<ul>
<li>Keepalived高可用服务之间的故障切换转移，是通过VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议）来实现的。</li>
<li>在Keepalived服务正常工作时，主Master节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备Backup节点自己还活着，当主Master节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主Master节点的心跳了，于是调用自身的接管程序，接管主Master节点的IP资源及服务。而当主Master节点恢复时，备Backup节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。</li>
<li>VRRP协议：<br>VRRP，全称Virtual Router Redundancy Protocol，中文名为虚拟路由冗余协议，VRRP的出现就是为了解决静态路由的单点故障问题，VRRP是通过一种竞选机制来将路由的任务交给某台VRRP路由器的。</li>
</ul>
<h2 id="二，Keepalived高可用服务搭建准备"><a href="#二，Keepalived高可用服务搭建准备" class="headerlink" title="二，Keepalived高可用服务搭建准备"></a>二，Keepalived高可用服务搭建准备</h2><h3 id="2-1-安装Keepalived环境"><a href="#2-1-安装Keepalived环境" class="headerlink" title="2.1 安装Keepalived环境"></a>2.1 安装Keepalived环境</h3><blockquote>
<p>nginx装高可用需要三块网卡，一块连接外网，一块连接内网，还有一块直连keepalive心跳线。</p>
</blockquote>
<p><strong>首先添加一块网卡，用于直连心跳线</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# <span class="built_in">cd</span> /etc/sysconfig/network-scripts/</span><br><span class="line">[root@nginx-master network-scripts]# <span class="built_in">cp</span> ifcfg-eth0 ifcfg-eth1</span><br><span class="line">[root@nginx-master network-scripts]# vim ifcfg-eth1</span><br><span class="line">DEVICE=eth1</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">NM_CONTROLLED=<span class="built_in">yes</span></span><br><span class="line">BOOTPROTO=dhcp              <span class="comment">#因为是仅主机模式</span></span><br><span class="line"><span class="comment">#IPADDR=192.168.27.203</span></span><br><span class="line"><span class="comment">#NETMASK=255.255.255.0</span></span><br><span class="line"><span class="comment">#GATEAWY=192.168.27.1</span></span><br><span class="line"><span class="comment">#DNS1=202.106.0.20</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-开始安装Keepalived软件"><a href="#2-2-开始安装Keepalived软件" class="headerlink" title="2.2 开始安装Keepalived软件"></a>2.2 开始安装Keepalived软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# yum -y install keepalived            <span class="comment">#主备两台都安装</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-启动Keepalived服务并检查"><a href="#2-3-启动Keepalived服务并检查" class="headerlink" title="2.3 启动Keepalived服务并检查"></a>2.3 启动Keepalived服务并检查</h3><p><strong>启动及检查Keepalived服务的命令如下：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@nginx-master ~]# ps -ef | grep keep | grep -v grep</span><br><span class="line">root       1330      1  0 01:15 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root       1332   1330  0 01:15 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root       1333   1330  0 01:15 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line"></span><br><span class="line"><span class="comment">#提示：启动后有3个Keepalived进程表示安装正确</span></span><br><span class="line"></span><br><span class="line">[root@nginx-master ~]# ip add | grep 192.168        <span class="comment">#提示：启动后有3个Keepalived进程表示安装正确</span></span><br><span class="line">    inet 192.168.131.132/24 brd 192.168.131.255 scope global eth0</span><br><span class="line">    inet 192.168.200.16/32 scope global eth0</span><br><span class="line">    inet 192.168.200.17/32 scope global eth0</span><br><span class="line">    inet 192.168.200.18/32 scope global eth0</span><br><span class="line">    inet 192.168.88.128/24 brd 192.168.88.255 scope global eth1</span><br><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明：主备两台都需要测试</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-Keepalived配置文件说明"><a href="#2-4-Keepalived配置文件说明" class="headerlink" title="2.4 Keepalived配置文件说明"></a>2.4 Keepalived配置文件说明</h3><p><code>vim /etc/keepalived/keepalived.conf</code></p>
<p><strong>这里的具备高可用功能的Keepalived.conf配置文件包含了两个重要区块</strong></p>
<p>（1）全局定义（Global Definitions）部分</p>
<p>这部分主要用来设置Keepalived的故障通知机制和Router ID标识。示例代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# <span class="built_in">head</span> -13 /etc/keepalived/keepalived.conf | <span class="built_in">cat</span> -n</span><br><span class="line">     1  ! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">     2  </span><br><span class="line">     3  global_defs &#123;</span><br><span class="line">     4     notification_email &#123;</span><br><span class="line">     5       acassen@firewall.loc</span><br><span class="line">     6       failover@firewall.loc</span><br><span class="line">     7       sysadmin@firewall.loc</span><br><span class="line">     8     &#125;</span><br><span class="line">     9     notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    10     smtp_server 192.168.200.1</span><br><span class="line">    11     smtp_connect_timeout 30</span><br><span class="line">    12     router_id LVS_DEVEL</span><br><span class="line">    13  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>基础参数说明：</strong></p>
<p>第1行是注释，！开头和#号开发一样，都是注释。<br>第2行是空行。<br>第3~8行是定义服务故障报警的Email地址。作用是当服务发生切换或RS节点等有故障时，发报警邮件。这几行是可选配置，notification_email指定在Keepalived发生事件时，需要发送的Email地址，可以有多个，每行一个。<br>第9行是指定发送邮件的发送人，即发件人地址，也是可选的配置。<br>第10行smtp_server指定发送邮件的smtp服务器，如果本机开启了sendmail或postfix，就可以使用上面默认配置实现邮件发送，也是可选配置。<br>第11行smtp_connect_timeout是连接smtp的超时时间，也是可选配置。</p>
<p>注意：<br>第4~11行所有和邮件报警相关的参数均可以不配，在实际工作中会将监控的任务交给更加擅长监控报警的Nagios或Zabbix软件。<br>第12行是Keepalived服务器的路由标识（router_id）.在一个局域网内，这个标识（router_id）应该是唯一的。<br>大括号“{}”。用来分隔区块，要成对出现。如果漏写了半个大括号，Keepalived运行时，不会报错，但也不会得到预期的结果。另外，由于区块间存在多层嵌套关系，因此很容易遗漏区块结尾处的大括号，要特别注意。</p>
<p>（2）VRRP实例定义区块（VRRP instance（s））部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# sed -n <span class="string">&#x27;15,30&#123;=;p&#125;&#x27;</span> /etc/keepalived/keepalived.conf | xargs -L2</span><br><span class="line">15 vrrp_instance VI_1 &#123;</span><br><span class="line">16 state MASTER</span><br><span class="line">17 interface eth0</span><br><span class="line">18 virtual_router_id 51</span><br><span class="line">19 priority 100</span><br><span class="line">20 advert_int 1</span><br><span class="line">21 authentication &#123;</span><br><span class="line">22 auth_type PASS</span><br><span class="line">23 auth_pass 1111</span><br><span class="line">24 &#125;</span><br><span class="line">25 virtual_ipaddress &#123;</span><br><span class="line">26 192.168.200.16</span><br><span class="line">27 192.168.200.17</span><br><span class="line">28 192.168.200.18</span><br><span class="line">29 &#125;</span><br><span class="line">30 &#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<p>第15行表示定义一个vrrp_instance实例，名字是VI_1,每个vrrp_instance实例可以认为是Keepalived服务的一个实例或者作为一个业务服务，在Keepalived服务配置中，这样的vrrp_instance实例可以有多个。注意，存在于主节点中的vrrp_instance实例在备节点中也要存在，这样才能实现故障切换接管。</p>
<p>第16行state MASTER表示当前实例VI_1的角色状态，当前角色为MASTER，这个状态只能有MASTER和BACKUP两种状态，并且需要大写这些字符。其中MASTER为正式工作的状态，BACKUP为备用的状态。当MASTER所在的服务器故障或失效时，BACKUP所在的服务器会接管故障的MASTER继续提供服务。</p>
<p>第17行interface为网络通信接口。为对外提供服务的网络接口，如eth0,eth1。当前主流的服务器都有2~4个网络接口，在选择服务接口时，要搞清楚了。</p>
<p>第18行virtual_router_id为虚拟路由ID标识，这个标识最好是一个数字，并且要在一个keepalived.conf配置中是唯一的。但是MASTER和BACKUP配置中相同实例的virtual_router_id又必须是一致的，否则将出现脑裂问题。</p>
<p>第19行priority为优先级，其后面的数值也是一个数字，数字越大，表示实例优先级越高。在同一个vrrp_instance实例里，MASTER的优先级配置要高于BACKUP的。若MASTER的priority值为150，那么BACKUP的priority必须小于150，一般建议间隔50以上为佳，例如：设置BACKUP的priority为100或更小的数值。</p>
<p>第20行advert_int为同步通知间隔。MASTER与BACKUP之间通信检查的时间间隔，单位为秒，默认为1.</p>
<p>第21~24行authentication为权限认证配置。包含认证类型（auth_type）和认证密码（auth_pass）。认证类型有PASS（Simple Passwd（suggested）），AH（IPSEC（not recommended））两种，官方推荐使用的类型为PASS。验证密码为明文方式，最好长度不要超过8个字符，建议用4位数字，同一vrrp实例的MASTER与BACKUP使用相同的密码才能正常通信。</p>
<p>第25 ~ 29 行virtual_ipaddress为虚拟IP地址。可以配置多个IP地址，每个地址占一行，配置时最好明确指定子网掩码以及虚拟IP绑定的网络接口。否则，子网掩码默认是32位，绑定的接口和前面的interface参数配置的一致。注意，这里的虚拟IP就是在工作中需要和域名绑定的IP，即和配置的高可用服务监听的IP要保持一致！</p>
<h2 id="三，Keepalived高可用服务单实例"><a href="#三，Keepalived高可用服务单实例" class="headerlink" title="三，Keepalived高可用服务单实例"></a>三，Keepalived高可用服务单实例</h2><h3 id="3-1-配置Keepalived实现单实例单IP自动漂移接管"><a href="#3-1-配置Keepalived实现单实例单IP自动漂移接管" class="headerlink" title="3.1 配置Keepalived实现单实例单IP自动漂移接管"></a>3.1 配置Keepalived实现单实例单IP自动漂移接管</h3><p>（1）配置Keepalived主服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#删掉已有的所有默认配置，加入经过修改好的如下配置：</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        424219678@qq.com            <span class="comment">#邮箱随便写</span></span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1            <span class="comment">#邮件服务器IP</span></span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id nginx-master           <span class="comment">#id为nginx-master，不能和其他Keepalived节点相同（全局唯一）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;                <span class="comment">#实例名字为VI_1,相同实例的备节点名字要和这个相同</span></span><br><span class="line">    state MASTER                    <span class="comment">#状态为MASTER，备节点状态需要为BACKUP</span></span><br><span class="line">    interface eth1                  <span class="comment">#通信（心跳）接口为eth1，此参数备节点设置和主节点相同</span></span><br><span class="line">    virtual_router_id 55            <span class="comment">#实例ID为55，要和备节点相同</span></span><br><span class="line">    priority 150                    <span class="comment">#优先级为150，备节点的优先级必须比此数字低</span></span><br><span class="line">    advert_int 1                    <span class="comment">#通信检查间隔时间1秒</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS              <span class="comment">#PASS认证类型，此参数备节点设置和主节点相同</span></span><br><span class="line">        auth_pass 1111              <span class="comment">#密码1111，此参数备节点设置和主节点相同</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.240/24 dev eth0 label eth0:1        <span class="comment">#虚拟IP，即VIP为192.168.131.240,子网掩码为24位，绑定接口为eth0，别名为eth0：1，此参数备节点设置和主节点相同</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置完毕后，启动Keepalived服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@nginx-master ~]# ifconfig </span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          inet addr:192.168.131.132  Bcast:192.168.131.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fed5:7125/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:7970 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2302 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:574674 (561.2 KiB)  TX bytes:312605 (305.2 KiB)</span><br><span class="line"></span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25                     <span class="comment">#成功了</span></span><br><span class="line">          inet addr:192.168.131.240  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:D5:71:2F  </span><br><span class="line">          inet addr:192.168.88.128  Bcast:192.168.88.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fed5:712f/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:55 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:7316 (7.1 KiB)  TX bytes:4848 (4.7 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（2）实战配置Keepalived备服务器lb02 BACKUP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        424219678@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id nginx-slave            <span class="comment">#此参数和nginx-master MASTER不同</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;                <span class="comment">#此参数和nginx-master MASTER同</span></span><br><span class="line">    state BACKUP                    <span class="comment">#此参数和nginx-master MASTER不同</span></span><br><span class="line">    interface eth1                  <span class="comment">#此参数和nginx-master MASTER同</span></span><br><span class="line">    virtual_router_id 55            <span class="comment">#此参数和nginx-master MASTER同</span></span><br><span class="line">    priority 100                    <span class="comment">#此参数和nginx-master MASTER不同</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.240/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置完成后，启动Keepalived服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-slave ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（3）进行高可用主备服务器切换实验</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# ifconfig eth0:1</span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          inet addr:192.168.131.240  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">[root@nginx-master ~]# ifconfig eth0:1</span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line"><span class="comment">#这时候看slave服务器</span></span><br><span class="line">[root@nginx-slave ~]# ifconfig eth0:1               <span class="comment">#漂移成功</span></span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:B3:7E:B5  </span><br><span class="line">          inet addr:192.168.131.240  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>主节点启动Keepalived服务后，发现很快就又接管了VIP 192.168.131.240</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@nginx-master ~]# ifconfig eth0:1</span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          inet addr:192.168.131.240  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="五，Keepalived双实例双主模式配置"><a href="#五，Keepalived双实例双主模式配置" class="headerlink" title="五，Keepalived双实例双主模式配置"></a>五，Keepalived双实例双主模式配置</h2><p><strong>首先，配置nginx-master的Keepalived.conf，在单实例的基础上增加一个vrrp_instance VI_2实例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        424219678@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id nginx-master</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.240/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 56</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.250/24 dev eth0 label eth0:2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#提示：</span></span><br><span class="line">以vrrp_instance VI_1在master服务器上的角色为主，vrrp_instance VI_2在slave服务器上的角色为备。</span><br></pre></td></tr></table></figure>

<p><strong>然后配置nginx-slave的Keepalived.conf，在单实例的基础上增加vrrp_instance VI_2实例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        424219678@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id nginx-slave</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.240/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 56</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.131.250/24 dev eth0 label eth0:2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>重启服务(两台)</strong><br>示例一台：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master ~]# /etc/init.d/keepalived restart</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭slave服务器的keepalive服务，查看master服务器</span></span><br><span class="line">[root@nginx-master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          inet addr:192.168.131.132  Bcast:192.168.131.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fed5:7125/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8916 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2574 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:642080 (627.0 KiB)  TX bytes:348713 (340.5 KiB)</span><br><span class="line"></span><br><span class="line">eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25  </span><br><span class="line">          inet addr:192.168.131.240  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">eth0:2    Link encap:Ethernet  HWaddr 00:0C:29:D5:71:25                         <span class="comment">#漂移成功</span></span><br><span class="line">          inet addr:192.168.131.250  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:D5:71:2F  </span><br><span class="line">          inet addr:192.168.88.128  Bcast:192.168.88.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fed5:712f/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:166 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1039 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:15552 (15.1 KiB)  TX bytes:59022 (57.6 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="四，Keepalived高可用服务器的“裂脑”问题"><a href="#四，Keepalived高可用服务器的“裂脑”问题" class="headerlink" title="四，Keepalived高可用服务器的“裂脑”问题"></a>四，Keepalived高可用服务器的“裂脑”问题</h2><h3 id="4-1-什么是裂脑"><a href="#4-1-什么是裂脑" class="headerlink" title="4.1 什么是裂脑"></a>4.1 什么是裂脑</h3><blockquote>
<p>由于某些原因，导致两台高可用服务器对在指定时间内，无法检测到对方的心跳消息，各自取得资源及服务的所有权，而此时的两台高可用服务器对都还活着并在正常运行，这样就会导致同一个IP或服务在两端同时存在而发生冲突，最严重的是两台主机占用同一个VIP地址，当用户写入数据时可能会分别写入到两端，这可能会导致服务器两端的数据不一致或造成数据丢失，这种情况就被称为裂脑。</p>
</blockquote>
<h3 id="4-2，导致裂脑发生的原因"><a href="#4-2，导致裂脑发生的原因" class="headerlink" title="4.2，导致裂脑发生的原因"></a>4.2，导致裂脑发生的原因</h3><p><strong>一般来说，裂脑的发生，有以下几种原因：</strong></p>
<ul>
<li>高可用服务器对之间心跳线链路发生故障，导致无法正常通信。</li>
<li>心跳线坏了（包括断了,老化）</li>
<li>网卡及相关驱动坏了，IP配置及冲突问题（网卡直连）。</li>
<li>心跳线间连接的设备故障（网卡及交换机）</li>
<li>仲裁的机器出问题（采用仲裁的方案）</li>
<li>高可用服务器上开启了iptables防火墙阻挡了心跳消息传输</li>
<li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败。</li>
<li>其他服务配置不当等原因，如心跳方式不同，心跳广播冲突，软件BUG等</li>
</ul>
<blockquote>
<p>提示：<br>Keepalived配置里同一VRRP实例如果virtual_router_id两端参数配置不一致，也会导致裂脑问题发生。</p>
</blockquote>
<h3 id="4-3-解决裂脑的常见方案"><a href="#4-3-解决裂脑的常见方案" class="headerlink" title="4.3 解决裂脑的常见方案"></a>4.3 解决裂脑的常见方案</h3><p><strong>在实际生产环境中，我们可以从以下几个方面来防止裂脑问题的发生：</strong></p>
<ul>
<li>同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一个还是好的，依然能传送心跳消息。</li>
<li>当检测到裂脑时强行关闭一个心跳节点（这个功能需特殊设备支持，如Stonith，fence）。相当于备节点接收不到心跳消息，通过单独的线路发送关机命令关闭主节点的电源。</li>
<li>做好对裂脑的监控报警（如邮件及手机短信等或值班），在问题发生时人为第一时间介入仲裁，降低损失。例如，百度的监控报警短信就有上行和下行的区别。报警信息发送到管理员手机上，管理员可以通过手机回复对应数字或简单的字符串操作返回给服务器，让服务器根据指令自动处理相应故障，这样解决故障的时间更短。</li>
<li>当然，在实施高可用方案时，要根据业务实际需求确定是否能容忍这样的损失。对于一般的网站常规业务，这个损失是可容忍的。</li>
</ul>
<h3 id="4-4-解决Keepalived裂脑的常见方案"><a href="#4-4-解决Keepalived裂脑的常见方案" class="headerlink" title="4.4 解决Keepalived裂脑的常见方案"></a>4.4 解决Keepalived裂脑的常见方案</h3><blockquote>
<p>作为互联网应用服务器的高可用，特别是前端Web负载均衡器的高可用，裂脑的问题对普通业务的影响是可以忍受的，如果是数据库或者存储的业务，一般出现裂脑问题就非常严重了。因此，可以通过增加冗余心跳线路来避免裂脑问题的发生，同时加强对系统的监控，以便裂脑发生时人为快速介入解决问题。</p>
</blockquote>
<ul>
<li>如果开启防火墙，一定要让心跳消息通过，一般通过允许IP段的形式解决。</li>
<li>可以拉一条以太网网线或者串口线作为主被节点心跳线路的冗余。</li>
<li>开发检测程序通过监控软件（例如Nagios）检测裂脑。</li>
</ul>
<p><strong>生产场景检测裂脑故障的一些思路：</strong></p>
<p>1)简单判断的思想：只要备节点出现VIP就报警，这个报警有两种情况，一是主机宕机了备机接管了；二是主机没宕，裂脑了。不管属于哪个情况，都进行报警，然后由人工查看判断及解决。</p>
<p>2）比较严谨的判断：备节点出现对应VIP，并且主节点及对应服务（如果能远程连接主节点看是否有VIP就更好了）还活着，就说明发生裂脑了。</p>
<h2 id="五，开发检测Keepalived裂脑的脚本"><a href="#五，开发检测Keepalived裂脑的脚本" class="headerlink" title="五，开发检测Keepalived裂脑的脚本"></a>五，开发检测Keepalived裂脑的脚本</h2><p>1）在nginx-slave备节点开发脚本并执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-slave scripts]# <span class="built_in">cat</span> check_split_brain.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">nginx_master_vip=192.168.131.240</span><br><span class="line">nginx_aster_ip=192.168.131.132</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    ping -c 2 -W 3 <span class="variable">$nginx_aster_ip</span> &amp;&gt;/dev/null</span><br><span class="line">	<span class="keyword">if</span> [ $? -eq 0 -a `ip a | grep <span class="string">&quot;<span class="variable">$nginx_master_vip</span>&quot;</span> | <span class="built_in">wc</span> -l` -eq 1 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ha is split brain.warning.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ha is OK&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[root@nginx-slave scripts]# sh check_split_brain.sh </span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line"><span class="comment">#正常情况下，主节点活着，VIP 192.168.131.132在主节点，因此不会报警，提示“ha is OK”</span></span><br></pre></td></tr></table></figure>

<p>2）停止Keepalived服务看nginx-slave脚本执行情况。</p>
<p><strong>nginx-master上：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-master scripts]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">[root@nginx-master scripts]# ip a | grep 192.168.0.240</span><br><span class="line">[root@nginx-master scripts]# </span><br><span class="line"><span class="comment">#在nginx-slave上观察即可，此前脚本已经执行。</span></span><br><span class="line">[root@nginx-slave scripts]# sh check_split_brain.sh </span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br></pre></td></tr></table></figure>

<p>3）关掉nginx-master服务器，然后再观察nginx-slave脚本的输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-slave scripts]# sh check_split_brain.sh </span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br><span class="line">ha is <span class="built_in">split</span> brain.warning.</span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line">ha is OK</span><br><span class="line"><span class="comment">#裂脑报警恢复了。</span></span><br></pre></td></tr></table></figure>

<h2 id="六，解决高可用服务只针对物理服务器的问题"><a href="#六，解决高可用服务只针对物理服务器的问题" class="headerlink" title="六，解决高可用服务只针对物理服务器的问题"></a>六，解决高可用服务只针对物理服务器的问题</h2><h3 id="第一种（主服务器）"><a href="#第一种（主服务器）" class="headerlink" title="第一种（主服务器）"></a>第一种（主服务器）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 scripts]# <span class="built_in">cat</span> check_nginx.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ `netstat -antup | grep nginx | <span class="built_in">wc</span> -l` -ne 1 ];<span class="keyword">then</span></span><br><span class="line">        /etc/init.d/keepalived stop</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#此脚本的基本思想是若没有80端口存在，就停掉Keepalived服务实现释放本地的VIP。在后台执行上述脚本并检查：</span></span><br><span class="line">[root@lb01 scripts]# sh check_nginx.sh &amp;</span><br><span class="line">[1] 1521</span><br><span class="line">[root@lb01 scripts]# ps -ef | grep check | grep -v grep</span><br><span class="line">root       1521   1195  0 10:49 pts/0    00:00:00 sh check_nginx.sh</span><br><span class="line"><span class="comment">#确认Nginx以及Keepalived服务是正常的</span></span><br><span class="line">[root@lb01 scripts]# netstat -antup | grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      1492/nginx          </span><br><span class="line">[root@lb01 scripts]# /etc/init.d/keepalived status</span><br><span class="line">keepalived (pid  1512) is running...</span><br><span class="line"><span class="comment">#然后模拟Nginx服务挂掉，看IP是否发生切换。</span></span><br><span class="line">[root@lb01 scripts]# /usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">[root@lb01 scripts]# Stopping keepalived:                  [  OK  ]</span><br><span class="line">[root@lb01 scripts]# /etc/init.d/keepalived status</span><br><span class="line">keepalived is stopped</span><br><span class="line">[root@lb01 scripts]# netstat -antup | grep nginx</span><br><span class="line"><span class="comment">#此时，备节点已接管：</span></span><br><span class="line">[root@lb02 ~]# ip a | grep 192.168.0.240</span><br><span class="line">    inet 192.168.0.240/24 scope global secondary eth0:1</span><br></pre></td></tr></table></figure>

<h3 id="第二种（主服务器）"><a href="#第二种（主服务器）" class="headerlink" title="第二种（主服务器）"></a>第二种（主服务器）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 scripts]# <span class="built_in">cat</span> chk_nginx_proxy.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ `netstat -antup | grep nginx | <span class="built_in">wc</span> -l` -ne 1 ];<span class="keyword">then</span></span><br><span class="line">    /etc/init.d/keepalived stop</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[root@lb01 scripts]# <span class="built_in">chmod</span> +x chk_nginx_proxy.sh </span><br><span class="line">[root@lb01 scripts]# <span class="built_in">ls</span> -l chk_nginx_proxy.sh </span><br><span class="line">-rwxr-xr-x. 1 root root 102 Jul 31 10:59 chk_nginx_proxy.sh</span><br></pre></td></tr></table></figure>

<p>此时，Keepalived服务的完整配置为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 scripts]# <span class="built_in">cat</span> /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    215379068@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx_proxy &#123;       <span class="comment">#定义vrrp脚本，检测HTTP端口</span></span><br><span class="line">    script <span class="string">&quot;/server/scripts/chk_nginx_proxy.sh&quot;</span>     <span class="comment">#执行脚本，当Nginx服务有问题，就停掉Keepalived服务</span></span><br><span class="line">    interval 2          <span class="comment">#间隔2秒</span></span><br><span class="line">    weight 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">    192.168.0.240/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    chk_nginx_proxy         <span class="comment">#触发检查</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io">Kkabuzs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://kkabuzs.github.io/articles/2018/08/31/keepalivedgaokeyongjiqun/">https://kkabuzs.github.io/articles/2018/08/31/keepalivedgaokeyongjiqun/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://kkabuzs.github.io" target="_blank">kkabuzs博客屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Keepalived/">Keepalived</a></div><div class="post-share"><div class="social-share" data-image="/themes-img/touxiang.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/articles/2018/08/28/ansiblepiliangzidonghuaguanligongju/" title="Ansible批量自动化管理工具"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Ansible批量自动化管理工具</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Ansible批量自动化管理工具一， ansible简介 批量管理服务器的工具，无需部署agent，通过ssh进行管理   jenkins简介  可视化运维（主要用在可视化部署）持续构建，可以和git，svn结合可结合ssh实现可视化运维可结合ansible实现可视化运维  二，Python3与ansible的安装2.1 使用源码安装Python3.51234567891011[root@localhost ~]# yum -y install lrzsz vim net-tools gcc gcc-c++ ncurses ncurses-devel unzip zlib-devel zlib openssl-devel openssl           #安装支持包[root@localhost ~]# tar xf Python-3.5.2.tgz -C /usr/src/[root@localhost...</div></div></div></a><a class="pagination-related" href="/articles/2018/08/31/tomcatxiangjie/" title="Tomcat详解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Tomcat详解</div></div><div class="info-2"><div class="info-item-1"> 无论你跑多少距离，放弃很容易，停下来，肉体得到暂时的舒服，但你最终会一无所得。坚持或许很难，但你最后一定会有所收获，跑过的路，永远不会欺骗自己。  Tomcat详解一，Tomcat简介   Tomcat是Apache软件基金会（Apache Software Foundation）的Jakarta项目中的一个核心项目，由Apache，Sun和其他一些公司及个人共同开发而成。 Tomcat服务器是一个免费的开放源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP程序的首选。 Tomcat和Nginx，APache（httpd），lighttpd等Web服务器一样，具有处理HTML页面的功能，另外它还是一个Servlet和JSP容器，独立的Servlet容器是Tomcat的默认模式。不过，Tomcat处理静态HTML的能力不如Nginx／Apache服务器。  二，Tomcat安装2.1...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/themes-img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Kkabuzs</div><div class="author-info-description">学习记录和整理</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">三人行，必有我师！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">Keepalived高可用集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%EF%BC%8CKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">一，Keepalived高可用软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Keepalived%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 Keepalived介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Keepalived%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%B8%89%E4%B8%AA%E9%87%8D%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 Keepalived服务的三个重要功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2%E8%BD%AC%E7%A7%BB%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Keepalived高可用故障切换转移原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8CKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%E5%87%86%E5%A4%87"><span class="toc-number">1.2.</span> <span class="toc-text">二，Keepalived高可用服务搭建准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85Keepalived%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 安装Keepalived环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BC%80%E5%A7%8B%E5%AE%89%E8%A3%85Keepalived%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 开始安装Keepalived软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%90%AF%E5%8A%A8Keepalived%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 启动Keepalived服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Keepalived%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 Keepalived配置文件说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%EF%BC%8CKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%8D%95%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.3.</span> <span class="toc-text">三，Keepalived高可用服务单实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AEKeepalived%E5%AE%9E%E7%8E%B0%E5%8D%95%E5%AE%9E%E4%BE%8B%E5%8D%95IP%E8%87%AA%E5%8A%A8%E6%BC%82%E7%A7%BB%E6%8E%A5%E7%AE%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 配置Keepalived实现单实例单IP自动漂移接管</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%EF%BC%8CKeepalived%E5%8F%8C%E5%AE%9E%E4%BE%8B%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%BC%8F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">五，Keepalived双实例双主模式配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8CKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E2%80%9C%E8%A3%82%E8%84%91%E2%80%9D%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.</span> <span class="toc-text">四，Keepalived高可用服务器的“裂脑”问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%A3%82%E8%84%91"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 什么是裂脑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%EF%BC%8C%E5%AF%BC%E8%87%B4%E8%A3%82%E8%84%91%E5%8F%91%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2，导致裂脑发生的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%A7%A3%E5%86%B3%E8%A3%82%E8%84%91%E7%9A%84%E5%B8%B8%E8%A7%81%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 解决裂脑的常见方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%A7%A3%E5%86%B3Keepalived%E8%A3%82%E8%84%91%E7%9A%84%E5%B8%B8%E8%A7%81%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.4.</span> <span class="toc-text">4.4 解决Keepalived裂脑的常见方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%EF%BC%8C%E5%BC%80%E5%8F%91%E6%A3%80%E6%B5%8BKeepalived%E8%A3%82%E8%84%91%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="toc-number">1.6.</span> <span class="toc-text">五，开发检测Keepalived裂脑的脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%EF%BC%8C%E8%A7%A3%E5%86%B3%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%8F%AA%E9%92%88%E5%AF%B9%E7%89%A9%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text">六，解决高可用服务只针对物理服务器的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%EF%BC%88%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89"><span class="toc-number">1.7.1.</span> <span class="toc-text">第一种（主服务器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%EF%BC%88%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">第二种（主服务器）</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fenpianjiqun/" title="MongoDB-6.0.21离线分片集群部署">MongoDB-6.0.21离线分片集群部署</a><time datetime="2025-04-21T17:53:44.000Z" title="发表于 2025-04-22 01:53:44">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/22/mongodb-6-0-21-lixian-fubenjibushu/" title="MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式">MongoDB-6.0.21副本集离线部署手册-（Replica Set）副本集模式</a><time datetime="2025-04-21T17:51:21.000Z" title="发表于 2025-04-22 01:51:21">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2025/04/21/mongodb-6-0-21-lixian-danjiedianbushu/" title="MongoDB-6.0.21离线单节点部署">MongoDB-6.0.21离线单节点部署</a><time datetime="2025-04-21T15:55:06.000Z" title="发表于 2025-04-21 23:55:06">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/10/jichengyupaisheng/" title="继承与派生">继承与派生</a><time datetime="2023-05-10T05:52:52.000Z" title="发表于 2023-05-10 13:52:52">2023-05-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/2023/05/09/fengzhuang/" title="封装">封装</a><time datetime="2023-05-09T01:37:55.000Z" title="发表于 2023-05-09 09:37:55">2023-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Kkabuzs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>